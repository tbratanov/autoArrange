!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e="undefined"!=typeof globalThis?globalThis:e||self).core=e.core||{},e.core.min=t())}(this,(function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};function t(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}var n=function(){return(n=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function o(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){e.done?r(e.value):new n((function(t){t(e.value)})).then(s,a)}c((o=o.apply(e,t||[])).next())}))}function r(e,t){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function i(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var o=Array(e),r=0;for(t=0;t<n;t++)for(var i=arguments[t],s=0,a=i.length;s<a;s++,r++)o[r]=i[s];return o}var s=1,a=2,c=3,u=4;function d(e){return e.type===c?"timestamp":e.type===a?"number":e.type===s?"string":e.type===u?"object":"unknown"}function p(e){return e.constructor===Date?"timestamp":"number"==typeof e?"number":"string"==typeof e?"string":"object"==typeof e?"object":"string"}function h(e){var t={},n=d(e);if("object"===n){var o=Object.keys(e.value).reduce((function(t,n){var o=p(e.value[n]);if("object"===o){var r=function e(t){return Object.keys(t).reduce((function(n,o){var r=p(t[o]);return n[o]="object"===r?{type:"object",description:"",context:{},composite:e(t[o])}:{type:r,description:"",context:{}},n}),{})}(e.value[n]);t[n]={type:"object",description:"",context:{},composite:r}}else t[n]={type:o,description:"",context:{}};return t}),{});t.composite=o}return t.name=l(e.path.join("/")+"/"+e.name),t.type=n,t.description=e.description,t.context={},t}function l(e){return void 0!==e&&e.length>0&&"/"!==e[0]?"/"+e:e}function f(e){return"timestamp"===d(e)?Date.now():function e(t){if("object"!=typeof t)return t;return Object.keys(t).reduce((function(n,o){var r=t[o];return"object"==typeof r&&r.constructor!==Date?n[o]=e(r):r.constructor===Date?n[o]=new Date(r).getTime():r.constructor===Boolean?n[o]=r.toString():n[o]=r,n}),{})}(e.value)}function g(e){var t=function e(t){return t.reduce((function(t,n){return t.concat(Array.isArray(n)?e(n):n)}),[])}(e.root.getAggregateState()),n=t.sort((function(e,t){return e.state?t.state?t.state-e.state:-1:1}))[0];return{description:function(e){var t="";return e.forEach((function(e,n,o){var r=e.path.join(".");n===o.length-1?t+=r+"."+e.name+": "+e.description:t+=r+"."+e.name+": "+e.description+","})),t.length>100?t.slice(0,100)+"...":t}(t),value:n.state}}var v=function(e,t,n){if(null===e||"object"!=typeof e)throw new Error("Missing definition");if(null===t||"object"!=typeof t)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")},m=function(){function e(e,t,n,o,r){this.definition=e,this.system=t,this.transport=n,this.value=o,this.type=r,this.path=[],v(e,t,n),this.path=t.path.slice(0),this.path.push(t.name),this.name=e.name,this.description=e.description,n.createMetric(this)}return Object.defineProperty(e.prototype,"repo",{get:function(){var e;return null===(e=this.system)||void 0===e?void 0:e.repo},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),e.prototype.update=function(e){return this.value=e,this.transport.updateMetric(this)},e}(),y=function(e){function n(t,n,o,r){return e.call(this,t,n,o,r,a)||this}return t(n,e),n.prototype.incrementBy=function(e){this.update(this.value+e)},n.prototype.increment=function(){this.incrementBy(1)},n.prototype.decrement=function(){this.incrementBy(-1)},n.prototype.decrementBy=function(e){this.incrementBy(-1*e)},n}(m),b=function(e){function n(t,n,o,r){return e.call(this,t,n,o,r,u)||this}return t(n,e),n.prototype.update=function(e){return this.mergeValues(e),this.transport.updateMetric(this)},n.prototype.mergeValues=function(e){var t=this;return Object.keys(this.value).forEach((function(n){void 0!==e[n]&&(t.value[n]=e[n])}))},n}(m),w=function(e){function n(t,n,o,r){return e.call(this,t,n,o,r,s)||this}return t(n,e),n}(m),S=function(e){function n(t,n,o,r){return e.call(this,t,n,o,r,c)||this}return t(n,e),n.prototype.now=function(){this.update(new Date)},n}(m);var _=function(){function e(e,t){t.init(this),this.root=function e(t,n,o,r,i){if(!n)throw new Error("Repository is required");if(!o)throw new Error("Transport is required");var d,p,h=o,l=t,f=i||"",g=n,v=r,m=function e(t){if(!t||!t.parent)return[];var n=e(t.parent);return n.push(t.name),n}(r),_={},I=(p="/",((d=m)&&d.length>0?d.join(p):"")+t),x=n.root,k=[],M=[];function C(e,t,n,o){var r={name:""};r="string"==typeof e?{name:e}:e;var i=M.filter((function(e){return e.name===r.name}));if(i.length>0){var s=i[0];if(s.type!==t)throw new Error("A metric named "+r.name+" is already defined with different type.");return void 0!==n&&s.update(n).catch((function(){})),s}var a=o(r);return M.push(a),a}var T={get name(){return l},get description(){return f},get repo(){return g},get parent(){return v},path:m,id:I,root:x,get subSystems(){return k},get metrics(){return M},subSystem:function(t,n){if(!t||0===t.length)throw new Error("name is required");var o=k.filter((function(e){return e.name===t}));if(o.length>0)return o[0];var r=e(t,g,h,T,n);return k.push(r),r},getState:function(){return _},setState:function(e,t){_={state:e,description:t},h.updateSystem(T,_)},stringMetric:function(e,t){return C(e,s,t,(function(e){return new w(e,T,h,t)}))},timestampMetric:function(e,t){return C(e,c,t,(function(e){return new S(e,T,h,t)}))},objectMetric:function(e,t){return C(e,u,t,(function(e){return new b(e,T,h,t)}))},numberMetric:function(e,t){return C(e,a,t,(function(e){return new y(e,T,h,t)}))},getAggregateState:function(){var e=[];return Object.keys(_).length>0&&e.push({name:l,path:m,state:_.state,description:_.description}),k.forEach((function(t){var n=t.getAggregateState();n.length>0&&e.push.apply(e,n)})),e}};return h.createSystem(T),T}("",this,t),this.addSystemMetrics(this.root,e.clickStream||void 0===e.clickStream)}return e.prototype.addSystemMetrics=function(e,t){if("undefined"!=typeof navigator&&e.stringMetric("UserAgent",navigator.userAgent),t&&"undefined"!=typeof document){var n=e.subSystem("ClickStream"),o=function(e){var t;if(e.target){var o=e.target,r=o&&null!==(t=o.getAttribute("class"))&&void 0!==t?t:"";n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:r,id:o.id,type:"<"+o.tagName.toLowerCase()+">",href:o.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",o):document.attachEvent("onclick",o)}e.stringMetric("StartTime",(new Date).toString());var r=e.stringMetric("StartURL",""),i=e.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;r.update(s)}void 0!==window.glue42gd&&i.update(window.glue42gd.appName)}},e}(),I=function(){function e(){}return e.prototype.init=function(e){},e.prototype.createSystem=function(e){return Promise.resolve()},e.prototype.updateSystem=function(e,t){return Promise.resolve()},e.prototype.createMetric=function(e){return Promise.resolve()},e.prototype.updateMetric=function(e){return Promise.resolve()},e}(),x=function(){function e(e,t,n){this.api=e,this.lastCount=0,this.initialPublishTimeout=1e4,this.publishInterval=6e4,this.initialPublishTimeout=null!=t?t:this.initialPublishTimeout,this.publishInterval=null!=n?n:this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}return e.prototype.scheduleCollection=function(){var e=this;setTimeout((function(){e.collect(),setInterval((function(){e.collect()}),e.publishInterval)}),this.initialPublishTimeout)},e.prototype.collect=function(){try{this.collectMemory(),this.collectEntries()}catch(e){}},e.prototype.collectMemory=function(){var e=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:e.totalJSHeapSize,usedJSHeapSize:e.usedJSHeapSize}))},e.prototype.collectEntries=function(){var e=window.performance.getEntries();if(!(e.length<=this.lastCount)){this.lastCount=e.length;var t=e.map((function(e){return e.toJSON()}));this.system.stringMetric("entries",JSON.stringify(t))}},e}(),k=function(e){var t;t=e.connection&&"object"==typeof e.connection?function(e,t){var i,s,a=this;if(!e||"object"!=typeof e)throw new Error("Connection is required parameter");var c=function(e){u(e.root)},u=function(e){d(e),e.metrics.forEach((function(e){p(e)})),e.subSystems.forEach((function(e){u(e)}))},d=function(e){return o(a,void 0,void 0,(function(){var t,n;return r(this,(function(o){switch(o.label){case 0:return void 0===e.parent?[2]:[4,i];case 1:return o.sent(),t={name:l(e.path.join("/")+"/"+e.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}},n={type:"define",metrics:[t]},s.send(n),[2]}}))}))},p=function(e){return o(a,void 0,void 0,(function(){var t,n,o;return r(this,(function(r){switch(r.label){case 0:return t=m(e),[4,i];case 1:return r.sent(),n=h(t),o={type:"define",metrics:[n]},s.send(o),void 0!==t.value&&v(t),[2]}}))}))},v=function(e){if(y()){var t=f(e),n={type:"publish",values:[{name:l(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};return s.sendFireAndForget(n)}return Promise.resolve()},m=function(e){var t=n({},e);return"object"==typeof e.value&&null!==e.value&&(t.value=n({},e.value)),t},y=function(){var e;try{return(null!==(e=t.canUpdateMetric)&&void 0!==e?e:function(){return!0})()}catch(e){return!0}};return{init:function(n){var o;i=new Promise((function(e){o=e})),(s=e.domain("metrics")).onJoined((function(e){!e&&o&&(o(),o=void 0);var t={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};s.send(t),e&&c(n)})),s.join({system:t.system,service:t.service,instance:t.instance})},createSystem:d,updateSystem:function(t,n){return o(a,void 0,void 0,(function(){var o,a,c;return r(this,(function(r){switch(r.label){case 0:return[4,i];case 1:return r.sent(),o={type:"publish",values:[{name:l(t.path.join("/")+"/"+t.name+"/State"),value:{Description:n.description,Value:n.state},timestamp:Date.now()}]},s.send(o),a=g(t),c={type:"publish",peer_id:e.peerId,values:[{name:"/State",value:{Description:a.description,Value:a.value},timestamp:Date.now()}]},s.send(c),[2]}}))}))},createMetric:p,updateMetric:function(e){return o(a,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:return t=m(e),[4,i];case 1:return n.sent(),v(t),[2]}}))}))}}}(e.connection,e):new I;var i=new _(e,t).root;e.disableAutoAppSystem||(i=i.subSystem("App"));var s=function(e){var t,n=e.subSystem("reporting"),o={name:"features"},r=function(e,r,i){if(void 0===e||""===e)throw new Error("name is mandatory");if(void 0===r||""===r)throw new Error("action is mandatory");if(void 0===i||""===i)throw new Error("payload is mandatory");t?t.update({name:e,action:r,payload:i}):t=n.objectMetric(o,{name:e,action:r,payload:i})};return e.featureMetric=r,e}(i);return function(e,t){var n,o;if("undefined"==typeof window)return;var r=null===(o=null===(n=null===window||void 0===window?void 0:window.glue42gd)||void 0===n?void 0:n.metrics)||void 0===o?void 0:o.pagePerformanceMetrics;r&&(t=r);(null==t?void 0:t.enabled)&&new x(e,t.initialPublishTimeout,t.publishInterval)}(s,e.pagePerformanceMetrics),s};function M(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,n={};function o(n,o){var r=n instanceof Error?n:new Error(n);if(t)t(r);else{var i='[ERROR] callback-registry: User callback for key "'+o+'" failed: '+r.stack;if(e)switch(e.errorHandling){case"log":return console.error(i);case"silent":return;case"throw":throw new Error(i)}console.error(i)}}return{add:function(e,t,r){var i=n[e];return i||(i=[],n[e]=i),i.push(t),r&&setTimeout((function(){r.forEach((function(r){var i;if(null===(i=n[e])||void 0===i?void 0:i.includes(t))try{Array.isArray(r)?t.apply(void 0,r):t.apply(void 0,[r])}catch(t){o(t,e)}}))}),0),function(){var o=n[e];o&&(0===(o=o.reduce((function(e,n,o){return n===t&&e.length===o||e.push(n),e}),[])).length?delete n[e]:n[e]=o)}},execute:function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var i=n[e];if(!i||0===i.length)return[];var s=[];return i.forEach((function(n){try{var r=n.apply(void 0,t);s.push(r)}catch(t){s.push(void 0),o(t,e)}})),s},clear:function(){n={}},clearKey:function(e){n[e]&&delete n[e]}}}M.default=M;var C=M,T=function(){function e(e,t){var n=this;this.registry=C(),this.gw=e.facade,this.gw.connect((function(e,t){n.messageHandler(t)})).then((function(e){n.client=e}))}return Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return this.client?(this.client.send(e),Promise.resolve(void 0)):Promise.reject("not connected")},e.prototype.send=function(e){return Promise.reject("not supported")},e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.onConnectedChanged=function(e){e(!0)},e.prototype.close=function(){return Promise.resolve()},e.prototype.open=function(){return Promise.resolve()},e.prototype.name=function(){return"in-memory"},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.messageHandler=function(e){this.registry.execute("onMessage",e)},e}(),j=function(){function e(e,t){var n=this;this.logger=t,this.registry=C(),this.worker=new SharedWorker(e),this.worker.port.onmessage=function(e){n.messageHandler(e.data)}}return Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return this.worker.port.postMessage(e),Promise.resolve()},e.prototype.send=function(e){return Promise.reject("not supported")},e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.onConnectedChanged=function(e){e(!0)},e.prototype.close=function(){return Promise.resolve()},e.prototype.open=function(){return Promise.resolve()},e.prototype.name=function(){return"shared-worker"},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.messageHandler=function(e){this.registry.execute("onMessage",e)},e}(),P=function(){function e(){}return e.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var e=Number(window.glueDesktop.version.substr(0,1));return isNaN(e)?void 0:e}},e.isNode=function(){if(void 0!==e._isNode)return e._isNode;if("undefined"!=typeof window)return e._isNode=!1,!1;try{e._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(t){e._isNode=!1}return e._isNode},e}(),R=function(){function e(){var e=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(t,n){e.resolve=function(n){e.resolved=!0,t(n)},e.reject=function(t){e.rejected=!0,n(t)}}))}return e.delay=function(e){return new Promise((function(t){return setTimeout(t,e)}))},Object.defineProperty(e.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),e}(),O={};function A(e){var t=O[e];if(t)return t;var n=[];function o(){return(new Date).getTime()}var r,i,s=o();function a(e,t){var r=null!=t?t:o(),i=0;n.length>0&&(i=r-n[n.length-1].time),n.push({name:e,time:r,diff:i})}a("start",s);var c={get startTime(){return s},get endTime(){return r},get period(){return i},stop:function(){return a("end",r=o()),i=r-s},mark:a,marks:n};return O[e]=c,c}var E=P.isNode()?require("ws"):window.WebSocket,N=function(){function e(e,t){if(this.startupTimer=A("connection"),this._running=!0,this._registry=C(),this.wsRequests=[],this.settings=e,this.logger=t,!this.settings.ws)throw new Error("ws is missing")}return e.prototype.onMessage=function(e){return this._registry.add("onMessage",e)},e.prototype.send=function(e,t){var n=this;return new Promise((function(t,o){n.waitForSocketConnection((function(){var r;try{null===(r=n.ws)||void 0===r||r.send(e),t()}catch(e){o(e)}}),o)}))},e.prototype.open=function(){var e=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(t,n){e.waitForSocketConnection(t,n)}))},e.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},e.prototype.onConnectedChanged=function(e){return this._registry.add("onConnectedChanged",e)},e.prototype.name=function(){return"ws "+this.settings.ws},e.prototype.reconnect=function(){var e;null===(e=this.ws)||void 0===e||e.close();var t=new R;return this.waitForSocketConnection((function(){t.resolve()})),t.promise},e.prototype.waitForSocketConnection=function(e,t){var n;t=null!=t?t:function(){},this._running?1!==(null===(n=this.ws)||void 0===n?void 0:n.readyState)?(this.wsRequests.push({callback:e,failed:t}),this.wsRequests.length>1||this.openSocket()):e():t("wait for socket on "+this.settings.ws+" failed - socket closed by user")},e.prototype.openSocket=function(e,t){return o(this,void 0,void 0,(function(){var n=this;return r(this,(function(o){switch(o.label){case 0:if(this.startupTimer.mark("opening-socket"),void 0===e&&(e=this.settings.reconnectInterval),void 0!==t){if(0===t)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+t+" more times (every "+e+" ms)")}o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return o.sent(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState(),[3,4];case 3:return o.sent(),setTimeout((function(){var o=void 0===t?void 0:t-1;n.openSocket(e,o)}),e),[3,4];case 4:return[2]}}))}))},e.prototype.initiateSocket=function(){var e=this,t=new R;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new E(this.settings.ws||""),this.ws.onerror=function(n){var o="";try{o=JSON.stringify(n)}catch(e){var r=new WeakSet;o=JSON.stringify(n,(function(e,t){if("object"==typeof t&&null!==t){if(r.has(t))return;r.add(t)}return t}))}t.reject("error"),e.notifyStatusChanged(!1,o)},this.ws.onclose=function(n){e.logger.info("ws closed "+n),t.reject("closed"),e.notifyStatusChanged(!1)},this.ws.onopen=function(){var n;e.startupTimer.mark("ws-opened"),e.logger.info("ws opened "+(null===(n=e.settings.identity)||void 0===n?void 0:n.application)),t.resolve(),e.notifyStatusChanged(!0)},this.ws.onmessage=function(t){e._registry.execute("onMessage",t.data)},t.promise},e.prototype.notifyForSocketState=function(e){this.wsRequests.forEach((function(t){e?t.failed&&t.failed(e):t.callback()})),this.wsRequests=[]},e.prototype.notifyStatusChanged=function(e,t){this._registry.execute("onConnectedChanged",e,t)},e}();var L=1;var D,q,F,U={nextValue:function(){return(L=(9301*L+49297)%233280)/233280},seed:function(e){L=e}},B="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function J(){F=!1}function V(e){if(e){if(e!==D){if(e.length!==B.length)throw new Error("Custom alphabet for shortid must be "+B.length+" unique characters. You submitted "+e.length+" characters: "+e);var t=e.split("").filter((function(e,t,n){return t!==n.lastIndexOf(e)}));if(t.length)throw new Error("Custom alphabet for shortid must be "+B.length+" unique characters. These characters were not unique: "+t.join(", "));D=e,J()}}else D!==B&&(D=B,J())}function W(){return F||(F=function(){D||V(B);for(var e,t=D.split(""),n=[],o=U.nextValue();t.length>0;)o=U.nextValue(),e=Math.floor(o*t.length),n.push(t.splice(e,1)[0]);return n.join("")}())}var H={characters:function(e){return V(e),D},seed:function(e){U.seed(e),q!==e&&(J(),q=e)},lookup:function(e){return W()[e]},shuffled:W},K="object"==typeof window&&(window.crypto||window.msCrypto);var G=function(){if(!K||!K.getRandomValues)return 48&Math.floor(256*Math.random());var e=new Uint8Array(1);return K.getRandomValues(e),48&e[0]};var z=function(e,t){for(var n,o=0,r="";!n;)r+=e(t>>4*o&15|G()),n=t<Math.pow(16,o+1),o++;return r};var X=function(e){var t=H.shuffled();return{version:15&t.indexOf(e.substr(0,1)),worker:15&t.indexOf(e.substr(1,1))}};var Y=function(e){if(!e||"string"!=typeof e||e.length<6)return!1;for(var t=H.characters(),n=e.length,o=0;o<n;o++)if(-1===t.indexOf(e[o]))return!1;return!0},Q=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e){var t,n,o=0;function r(){var e="",r=Math.floor(.001*(Date.now()-1459707606518));return r===n?t++:(t=0,n=r),e+=z(H.lookup,6),e+=z(H.lookup,o),t>0&&(e+=z(H.lookup,t)),e+=z(H.lookup,r)}e.exports=r,e.exports.generate=r,e.exports.seed=function(t){return H.seed(t),e.exports},e.exports.worker=function(t){return o=t,e.exports},e.exports.characters=function(e){return void 0!==e&&H.characters(e),H.shuffled()},e.exports.decode=X,e.exports.isValid=Y})),Z=(Q.generate,Q.seed,Q.worker,Q.characters,Q.decode,Q.isValid,Q);function $(e,t,n,o,r){null==e&&(e="global"),o=o||["success"],r=r||["error"];var i,s=!1,a=!1,c=!1,u=C();t.disconnected((function(){c=!1,n.debug("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),t.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),p(i))})),t.on("success",(function(e){return l(e)})),t.on("error",(function(e){return h(e)})),t.on("result",(function(e){return l(e)})),o&&o.forEach((function(e){t.on(e,(function(e){return l(e)}))})),r&&r.forEach((function(e){t.on(e,(function(e){return h(e)}))}));var d={};function p(t){return i=t,new Promise((function(o,r){if(s)o();else{var i;if("global"===e)i=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining domain "+e),i=g({type:"join",destination:e,domain:"global",options:t});i.then((function(){!function(){n.debug("did join "+e),s=!0;var t=a;a=!1,u.execute("onJoined",t)}(),o()})).catch((function(t){n.debug("error joining "+e+" domain: "+JSON.stringify(t)),r(t)}))}}))}function h(t){if(e===t.domain){var n=t.request_id;if(n){var o=d[n];o&&o.error(t)}}}function l(t){if(t.domain===e){var n=t.request_id;if(n){var o=d[n];o&&o.success(t)}}}function f(){return Z()}function g(o,r,i){i=i||{},o.request_id=o.request_id||f(),o.domain=o.domain||e,i.skipPeerId||(o.peer_id=t.peerId);var s=o.request_id;return new Promise((function(e,a){d[s]={success:function(t){delete d[s],t._tag=r,e(t)},error:function(e){n.warn("GW error - "+JSON.stringify(e)+" for request "+JSON.stringify(o)),delete d[s],e._tag=r,a(e)}},t.send(o,i).catch((function(e){d[s].error({err:e})}))}))}return{join:p,leave:function(){return"global"===e?Promise.resolve():(n.debug("stopping session "+e+"..."),a=!1,g({type:"leave",destination:e,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})).catch((function(){s=!1,u.execute("onLeft")})))},onJoined:function(e){return s&&e(!1),u.add("onJoined",e)},onLeft:function(e){return s||e(),u.add("onLeft",e)},send:g,sendFireAndForget:function(n){return n.request_id=n.request_id?n.request_id:f(),n.domain=n.domain||e,n.peer_id=t.peerId,t.send(n)},on:function(o,r){t.on(o,(function(t){if(t.domain===e)try{r(t)}catch(e){n.error("Callback  failed: "+e+" \n "+e.stack+" \n msg was: "+JSON.stringify(t),e)}}))},loggedIn:function(e){return t.loggedIn(e)},connected:function(e){return t.connected(e)},disconnected:function(e){return t.disconnected(e)},get peerId(){return t.peerId},get domain(){return e}}}var ee=function(){function e(e,t,n){var o=this;this.connection=e,this.settings=t,this.logger=n,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=C(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],e.disconnected((function(){o.handleDisconnected()})),this.ping()}return Object.defineProperty(e.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),e.prototype.processStringMessage=function(e){var t=this,n=JSON.parse(e,(function(e,n){if("string"!=typeof n)return n;if(n.length<t.dateMinLen)return n;if(n[0]!==t.datePrefixFirstChar)return n;if(n.substring(0,t.datePrefixLen)!==t.datePrefix)return n;try{var o=parseInt(n.substring(t.datePrefixLen,n.length),10);return isNaN(o)?n:new Date(o)}catch(e){return n}}));return{msg:n,msgType:n.type}},e.prototype.createStringMessage=function(e){var t=Date.prototype.toJSON;try{var n=this.datePrefix;return Date.prototype.toJSON=function(){return n+this.getTime()},JSON.stringify(e)}finally{Date.prototype.toJSON=t}},e.prototype.processObjectMessage=function(e){if(!e.type)throw new Error("Object should have type property");return{msg:e,msgType:e.type}},e.prototype.createObjectMessage=function(e){return e},e.prototype.login=function(e,t){return o(this,void 0,void 0,(function(){var n,o,i,s,a,c,u,d,p,h;return r(this,(function(r){switch(r.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=e,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,n={},this.connection.gatewayToken=e.gatewayToken,!e.gatewayToken)return[3,5];if(!t)return[3,4];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return d=r.sent(),e.gatewayToken=d,[3,4];case 3:return o=r.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==o?void 0:o.message)||o)),[3,4];case 4:return n.method="gateway-token",n.token=e.gatewayToken,this.connection.gatewayToken=e.gatewayToken,[3,10];case 5:return"sspi"!==e.flowName?[3,9]:(n.provider="win",n.method="access-token",e.flowCallback&&e.sessionId?(i=n,[4,e.flowCallback(e.sessionId,null)]):[3,7]);case 6:return i.token=r.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(e.token)n.method="access-token",n.token=e.token;else{if(!e.username)throw new Error("invalid auth message"+JSON.stringify(e));n.method="secret",n.login=e.username,n.secret=e.password}r.label=10;case 10:s={type:"hello",identity:this.settings.identity,authentication:n},e.sessionId&&(s.request_id=e.sessionId),this.globalDomain=$("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),a={skipPeerId:!0},this.initialLogin&&(a.retryInterval=this.settings.reconnectInterval,a.maxRetries=this.settings.reconnectAttempts),r.label=11;case 11:r.trys.push([11,19,20,21]),c=void 0,r.label=12;case 12:return[4,this.globalDomain.send(s,void 0,a)];case 13:return"authentication-request"!==(u=r.sent()).type?[3,16]:(d=Buffer.from(u.authentication.token,"base64"),e.flowCallback&&e.sessionId?(p=s.authentication,[4,e.flowCallback(e.sessionId,d)]):[3,15]);case 14:p.token=r.sent().data.toString("base64"),r.label=15;case 15:return s.request_id=e.sessionId,[3,12];case 16:if("welcome"===u.type)return c=u,[3,18];throw"error"===u.type?new Error("Authentication failed: "+u.reason):new Error("Unexpected message type during authentication: "+u.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.debug("login successful with peerId "+c.peer_id),this.connection.peerId=c.peer_id,this.connection.resolvedIdentity=c.resolved_identity,this.connection.availableDomains=c.available_domains,c.options&&(this.connection.token=c.options.access_token,this.connection.info=c.options.info),this.setLoggedIn(!0),[2,c.resolved_identity];case 19:throw h=r.sent(),this.logger.error("error sending hello message - "+(h.message||h.msg||h.reason||h),h),h;case 20:return e&&e.flowCallback&&e.sessionId&&e.flowCallback(e.sessionId,null),[7];case 21:return[2]}}))}))},e.prototype.logout=function(){return o(this,void 0,void 0,(function(){var e;return r(this,(function(t){switch(t.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),e=this.sessions.map((function(e){e.leave()})),[4,Promise.all(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.loggedIn=function(e){return this._isLoggedIn&&e(),this.registry.add("onLoggedIn",e)},e.prototype.domain=function(e,t,n,o){var r=this.sessions.filter((function(t){return t.domain===e}))[0];return r||(r=$(e,this.connection,t,n,o),this.sessions.push(r)),r},e.prototype.handleDisconnected=function(){var e=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(e.handleDisconnected.bind(e),e.settings.reconnectInterval||1e3)}))}},e.prototype.setLoggedIn=function(e){this._isLoggedIn=e,this._isLoggedIn&&this.registry.execute("onLoggedIn")},e.prototype.ping=function(){var e=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){e.ping()}),3e4))},e.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(e){return e.token})):Promise.reject(new Error("no global domain session"))},e.prototype.getNewGWToken=function(){if(void 0!==typeof window){var e=window.glue42gd;if(e)return e.getGWToken()}return Promise.reject(new Error("not running in GD"))},e}(),te=function(){function e(e){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var t=0,n=e;t<n.length;t++){var o=n[t];this.specs[o.name]=o,this.specsNames.push(o.name)}}return e.prototype.init=function(e){var t=this;this.connection=e;for(var n=0,o=this.specsNames;n<o.length;n++)for(var r=o[n],i=function(n){var o=s.subsRefCount[n];if(o||(o=0),o+=1,s.subsRefCount[n]=o,o>1)return"continue";var r=e.on(n,(function(e){return t.processMessage(n,e)}));s.subs[n]=r},s=this,a=0,c=this.specs[r].types;a<c.length;a++){i(c[a])}},e.prototype.processMessage=function(e,t){if(!this.isDone&&t)for(var n=0,o=this.specsNames;n<o.length;n++){var r=o[n];if(-1!==this.specs[r].types.indexOf(e)){var i=this.messages[r]||[];this.messages[r]=i,i.push(t)}}},e.prototype.drain=function(e,t){var n;t&&(this.messages[e]||[]).forEach(t),delete this.messages[e];for(var o=0,r=this.specs[e].types;o<r.length;o++){var i=r[o];this.subsRefCount[i]-=1,this.subsRefCount[i]<=0&&(null===(n=this.connection)||void 0===n||n.off(this.subs[i]),delete this.subs[i],delete this.subsRefCount[i])}delete this.specs[e],this.specs.length||(this.isDone=!0)},e}(),ne=function(e,t,n){return new Promise((function(o,r){var i=setTimeout((function(){r(n||"Promise timeout hit: "+t)}),t);new Promise(e).then((function(e){clearTimeout(i),o(e)})).catch((function(e){clearTimeout(i),r(e)}))}))},oe=function(){function e(e,t,n){this.settings=e,this.logger=t,this.identity=n,this.parentReady=!1,this.iAmConnected=!1,this.rejected=!1,this.children=[],this.extContentAvailable=!1,this.extContentConnecting=!1,this.extContentConnected=!1,this.parentInExtMode=!1,this.parentPingTimeout=3e3,this.connectionRequestTimeout=5e3,this.defaultTargetString="*",this.registry=C(),this.messages={connectionAccepted:{name:"connectionAccepted",handle:this.handleConnectionAccepted.bind(this)},connectionRejected:{name:"connectionRejected",handle:this.handleConnectionRejected.bind(this)},connectionRequest:{name:"connectionRequest",handle:this.handleConnectionRequest.bind(this)},parentReady:{name:"parentReady",handle:this.handleParentReady.bind(this)},parentPing:{name:"parentPing",handle:this.handleParentPing.bind(this)},platformPing:{name:"platformPing",handle:this.handlePlatformPing.bind(this)},platformUnload:{name:"platformUnload",handle:this.handlePlatformUnload.bind(this)},platformReady:{name:"platformReady",handle:this.handlePlatformReady.bind(this)},clientUnload:{name:"clientUnload",handle:this.handleClientUnload.bind(this)},manualUnload:{name:"manualUnload",handle:this.handleManualUnload.bind(this)},extConnectionResponse:{name:"extConnectionResponse",handle:this.handleExtConnectionResponse.bind(this)},extSetupRequest:{name:"extSetupRequest",handle:this.handleExtSetupRequest.bind(this)}},this.extContentAvailable=!!window.glue42ext,this.setUpMessageListener(),this.setUpUnload(),this.settings.port||(this.parent=window.opener||window.top,this.parentType=window.opener?"opener":-1!==window.name.indexOf("#wsp")?"workspace":"top")}return Object.defineProperty(e.prototype,"transportWindowId",{get:function(){return this.publicWindowId},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return o(this,void 0,void 0,(function(){return r(this,(function(t){if(this.extContentConnected)return[2,window.postMessage({glue42ExtOut:e},this.defaultTargetString)];if(!this.port)throw new Error("Cannot send message, because the port was not opened yet");return this.port.postMessage(e),[2]}))}))},Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.send=function(){return Promise.reject("not supported")},e.prototype.onConnectedChanged=function(e){return this.registry.add("onConnectedChanged",e)},e.prototype.open=function(){return o(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return this.logger.debug("opening a connection to the web platform gateway."),[4,this.connect()];case 1:return e.sent(),this.notifyStatusChanged(!0),[2]}}))}))},e.prototype.close=function(){return Promise.resolve()},e.prototype.name=function(){return"web-platform"},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.connect=function(){return o(this,void 0,void 0,(function(){var e=this;return r(this,(function(t){switch(t.label){case 0:if(this.parentReady)return this.logger.debug("cancelling connection attempt, because this client's parent has already given a ready signal"),[2];if(this.settings.port)return this.logger.debug("opening an internal web platform connection"),this.port=this.settings.port,this.publicWindowId=this.settings.windowId,this.identity&&(this.identity.windowId=this.publicWindowId),this.port.onmessage=function(t){return e.registry.execute("onMessage",t.data)},this.logger.debug("internal web platform connection completed"),[2];if(!this.parentType||!this.parent)throw new Error("Cannot initiate a connection, because there is no opener, no top and no port.");return this.logger.debug("opening a "+("opener"===this.parentType?"child":"grandchild")+" client web platform connection"),[4,this.waitParent(this.parent,this.parentType)];case 1:return t.sent(),this.parentInExtMode?[4,this.requestConnectionPermissionFromExt()]:[3,3];case 2:t.sent(),t.label=3;case 3:return[4,this.initiateRemoteConnection(this.parent,this.parentType)];case 4:return t.sent(),this.logger.debug("the "+("opener"===this.parentType?"child":"grandchild")+" client is connected"),[2]}}))}))},e.prototype.initiateRemoteConnection=function(e,t){var n=this;return ne((function(o,r){n.connectionResolve=o,n.connectionReject=r,n.myClientId=Z();var i="workspace"===n.parentType?window.name.substring(0,window.name.indexOf("#wsp")):window.name,s={glue42core:{type:n.messages.connectionRequest.name,clientId:n.myClientId,clientType:"top"===t||"workspace"===t?"grandChild":"child",bridgeInstanceId:i}};if(n.logger.debug("sending connection request to "+t),n.extContentConnecting)return s.glue42core.clientType="child",s.glue42core.bridgeInstanceId=n.myClientId,s.glue42core.parentWindowId=n.parentWindowId,window.postMessage(s,n.defaultTargetString);e.postMessage(s,n.defaultTargetString)}),this.connectionRequestTimeout,"The connection to the opener/top window timed out")},e.prototype.waitParent=function(e,t){return o(this,void 0,void 0,(function(){var n,o,i=this;return r(this,(function(r){switch(r.label){case 0:if(n="Cannot initiate glue, because this window was not opened or created by a glue client",o=ne((function(o,r){var s=window.self!==window.top;if("top"===t&&!s)return r(n);i.parentPingResolve=o;var a={glue42core:{type:"opener"===t?i.messages.platformPing.name:i.messages.parentPing.name}};i.logger.debug("checking for "+t+" window availability"),e.postMessage(a,i.defaultTargetString)}),this.parentPingTimeout,n),!this.extContentAvailable)return[2,o];r.label=1;case 1:return r.trys.push([1,3,,5]),[4,o];case 2:return r.sent(),[2];case 3:return r.sent(),this.logger.debug("the parent check failed, but there is an associated extension content script, requesting permission..."),[4,this.requestConnectionPermissionFromExt()];case 4:return r.sent(),[3,5];case 5:return[2]}}))}))},e.prototype.setUpMessageListener=function(){var e=this;this.settings.port?this.logger.debug("skipping generic message listener, because this is an internal client"):window.addEventListener("message",(function(t){var n,o=null===(n=t.data)||void 0===n?void 0:n.glue42core;if(o&&!e.rejected)if(e.checkMessageTypeValid(o.type)){var r=o.type;e.logger.debug("received valid glue42core message of type: "+r),e.messages[r].handle(t)}else e.logger.error("cannot handle the incoming glue42 core message, because the type is invalid: "+o.type)}))},e.prototype.setUpUnload=function(){var e=this;this.settings.port?this.logger.debug("skipping unload event listener, because this is an internal client"):window.addEventListener("beforeunload",(function(){var t,n;if(!e.extContentConnected){var o={glue42core:{type:e.messages.clientUnload.name,data:{clientId:e.myClientId,ownWindowId:null===(t=e.identity)||void 0===t?void 0:t.windowId}}};e.parent&&e.parent.postMessage(o,e.defaultTargetString),null===(n=e.port)||void 0===n||n.postMessage(o)}}))},e.prototype.handleParentReady=function(e){var t;this.logger.debug("handling the ready signal from the parent, by resoling the pending promise."),this.parentReady=!0;var n=null===(t=e.data)||void 0===t?void 0:t.glue42core;if(n&&n.extMode&&(this.logger.debug("my parent is connected to its content script, fetching windowId and proceeding with content script connection"),this.parentWindowId=n.extMode.windowId,this.parentInExtMode=!0),this.parentPingResolve)return this.parentPingResolve(),void delete this.parentPingResolve;this.logger.debug("silently handling the ready signal from the top parent, because there is no defined promise")},e.prototype.handlePlatformReady=function(){if(this.logger.debug("the web platform gave the ready signal"),this.parentReady=!0,this.parentPingResolve)return this.parentPingResolve(),void delete this.parentPingResolve;this.logger.debug("silently handling the ready signal from the top parent, because there is no defined promise")},e.prototype.handleConnectionAccepted=function(e){var t,n=null===(t=e.data)||void 0===t?void 0:t.glue42core;return this.myClientId===n.clientId?this.handleAcceptanceOfMyRequest(n):this.handleAcceptanceOfGrandChildRequest(n,e)},e.prototype.handleAcceptanceOfMyRequest=function(e){var t=this;if(this.logger.debug("handling a connection accepted signal targeted at me."),this.extContentConnecting)return this.processExtContentConnection(e);if(e.port){if(this.publicWindowId="opener"===this.parentType?window.name:"top"===this.parentType?e.parentWindowId:window.name.substring(0,window.name.indexOf("#wsp")),this.identity&&"top"!==this.parentType&&(this.identity.windowId=this.publicWindowId),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),this.port=e.port,this.port.onmessage=function(e){return t.registry.execute("onMessage",e.data)},this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve;this.logger.error("unable to call the connection resolve, because no connection promise was found")}else this.logger.error("cannot set up my connection, because I was not provided with a port")},e.prototype.processExtContentConnection=function(e){var t=this;if(this.logger.debug("handling a connection accepted signal targeted at me for extension content connection."),this.extContentConnecting=!1,this.extContentConnected=!0,this.publicWindowId=this.parentWindowId||this.myClientId,this.extContentConnecting&&this.identity&&(this.identity.windowId=this.publicWindowId),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),window.addEventListener("message",(function(e){var n,o=null===(n=e.data)||void 0===n?void 0:n.glue42ExtInc;o&&t.registry.execute("onMessage",o)})),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve},e.prototype.handleAcceptanceOfGrandChildRequest=function(e,t){if(this.extContentConnecting||this.extContentConnected)this.logger.debug("cannot process acceptance of a grandchild, because I am connected to a content script");else{this.logger.debug("handling a connection accepted signal targeted at a grandchild: "+e.clientId);var n=this.children.find((function(t){return t.grandChildId===e.clientId}));n?(n.connected=!0,this.logger.debug("the grandchild connection for "+e.clientId+" is set up, forwarding the success message and the gateway port"),e.parentWindowId=this.publicWindowId,n.source.postMessage(t.data,n.origin,[e.port])):this.logger.error("cannot handle connection accepted for grandchild: "+e.clientId+", because there is no grandchild with this id")}},e.prototype.handleConnectionRejected=function(){this.logger.debug("handling a connection rejection. Most likely the reason is that this window was not created by a glue API call"),this.connectionReject&&(this.connectionReject("The platform connection was rejected. Most likely because this window was not created by a glue API call"),delete this.connectionReject)},e.prototype.handleConnectionRequest=function(e){if(this.extContentConnecting)this.logger.debug("This connection request event is targeted at the extension content");else{var t=e.source,n=e.data.glue42core;if(!n.clientType||"grandChild"!==n.clientType)return this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source was not opened by a glue API call");if(!n.clientId)return this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source did not provide a valid id");if("opener"!==this.parentType||!this.parent)return this.rejectConnectionRequest(t,e.origin,"Cannot forward the connection request, because no direct connection to the platform was found");this.logger.debug("handling a connection request for a grandchild: "+n.clientId),this.children.push({grandChildId:n.clientId,source:t,connected:!1,origin:e.origin}),this.logger.debug("grandchild: "+n.clientId+" is prepared, forwarding connection request to the platform"),this.parent.postMessage(e.data,this.defaultTargetString)}},e.prototype.handleParentPing=function(e){if(this.parentReady)if(this.iAmConnected){var t={glue42core:{type:this.messages.parentReady.name}};this.extContentConnected&&(t.glue42core.extMode={windowId:this.myClientId});var n=e.source;this.logger.debug("responding to a parent ping with a ready message"),n.postMessage(t,e.origin)}else this.logger.debug("i am not fully connected yet, I am ignoring the parent ping");else this.logger.debug("my parent is not ready, I am ignoring the parent ping")},e.prototype.handlePlatformUnload=function(e){this.logger.debug("detected a web platform unload"),this.parentReady=!1,this.children.length&&(this.logger.debug("forwarding the platform unload to all known children and starting platform discovery polling"),this.children.forEach((function(t){return t.source.postMessage(e.data,t.origin)}))),this.notifyStatusChanged(!1,"Gateway unloaded")},e.prototype.handleManualUnload=function(){var e,t,n={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:null===(e=this.identity)||void 0===e?void 0:e.windowId}}};if(this.parent&&this.parent.postMessage(n,this.defaultTargetString),this.extContentConnected)return window.postMessage({glue42ExtOut:n},this.defaultTargetString);null===(t=this.port)||void 0===t||t.postMessage(n)},e.prototype.handleClientUnload=function(e){var t=e.data.glue42core,n=null==t?void 0:t.data.clientId;n?this.children.find((function(e){return e.grandChildId===n}))?(this.logger.debug("handling grandchild unload for id: "+n),this.children=this.children.filter((function(e){return e.grandChildId!==n}))):this.logger.warn("cannot process grand child unload, because this client is unaware of this grandchild"):this.logger.warn("cannot process grand child unload, because the provided id was not valid")},e.prototype.handlePlatformPing=function(){this.logger.error("cannot handle platform ping, because this is not a platform calls handling component")},e.prototype.notifyStatusChanged=function(e,t){this.iAmConnected=e,this.registry.execute("onConnectedChanged",e,t)},e.prototype.checkMessageTypeValid=function(e){return"string"==typeof e&&!!this.messages[e]},e.prototype.rejectConnectionRequest=function(e,t,n){this.rejected=!0,this.logger.error(n);var o={glue42core:{type:this.messages.connectionRejected.name}};e.postMessage(o,t)},e.prototype.requestConnectionPermissionFromExt=function(){var e=this;return this.waitForContentScript().then((function(){return ne((function(t,n){e.extConnectionResolve=t,e.extConnectionReject=n;e.logger.debug("permission request to the extension content script was sent"),window.postMessage({glue42core:{type:"extSetupRequest"}},e.defaultTargetString)}),e.parentPingTimeout,"Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection timed out")}))},e.prototype.handleExtConnectionResponse=function(e){var t;if(!(null===(t=e.data)||void 0===t?void 0:t.glue42core).approved&&this.extConnectionReject)return this.extConnectionReject("Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection was rejected");this.extConnectionResolve&&(this.extContentConnecting=!0,this.logger.debug("The extension connection was approved, proceeding."),this.extConnectionResolve(),delete this.extConnectionResolve)},e.prototype.handleExtSetupRequest=function(){},e.prototype.waitForContentScript=function(){var e;return!!(null===(e=window.glue42ext)||void 0===e?void 0:e.content)?Promise.resolve():ne((function(e){window.addEventListener("Glue42EXTReady",(function(){e()}))}),this.connectionRequestTimeout,"The content script was available, but was never heard to be ready")},e}(),re=function(){function e(e,t){if(this.settings=e,this.logger=t,this.messageHandlers={},this.ids=1,this.registry=C(),this._connected=!1,this.isTrace=!1,(e=e||{}).reconnectAttempts=e.reconnectAttempts||10,e.reconnectInterval=e.reconnectInterval||1e3,e.inproc)this.transport=new T(e.inproc,t.subLogger("inMemory"));else if(e.sharedWorker)this.transport=new j(e.sharedWorker,t.subLogger("shared-worker"));else if(e.webPlatform)this.transport=new oe(e.webPlatform,t.subLogger("web-platform"),e.identity);else{if(void 0===e.ws)throw new Error("No connection information specified");this.transport=new N(e,t.subLogger("ws"))}this.isTrace=t.canPublish("trace"),t.debug("starting with "+this.transport.name()+" transport"),this.protocol=new ee(this,e,t.subLogger("protocol")),this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this.transport.onMessage(this.handleTransportMessage.bind(this)),e.replaySpecs&&e.replaySpecs.length&&(this.replayer=new te(e.replaySpecs),this.replayer.init(this))}return Object.defineProperty(e.prototype,"protocolVersion",{get:function(){var e;return null===(e=this.protocol)||void 0===e?void 0:e.protocolVersion},enumerable:!0,configurable:!0}),e.prototype.send=function(e,t){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var n=this.protocol.createObjectMessage(e);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(n)),this.transport.sendObject(n,t)}var o=this.protocol.createStringMessage(e);return this.isTrace&&this.logger.trace(">> "+o),this.transport.send(o,t)},e.prototype.on=function(e,t){e=e.toLowerCase(),void 0===this.messageHandlers[e]&&(this.messageHandlers[e]={});var n=this.ids++;return this.messageHandlers[e][n]=t,{type:e,id:n}},e.prototype.off=function(e){delete this.messageHandlers[e.type.toLowerCase()][e.id]},Object.defineProperty(e.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),e.prototype.connected=function(e){var t=this;return this.protocol.loggedIn((function(){e(t.settings.ws||t.settings.sharedWorker||"")}))},e.prototype.disconnected=function(e){return this.registry.add("disconnected",e)},e.prototype.login=function(e,t){return o(this,void 0,void 0,(function(){var n;return r(this,(function(o){switch(o.label){case 0:return[4,this.transport.open()];case 1:return o.sent(),A("connection").mark("transport-opened"),n=this.protocol.login(e,t),A("connection").mark("protocol-logged-in"),[2,n]}}))}))},e.prototype.logout=function(){return o(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.protocol.logout()];case 1:return e.sent(),[4,this.transport.close()];case 2:return e.sent(),[2]}}))}))},e.prototype.loggedIn=function(e){return this.protocol.loggedIn(e)},e.prototype.domain=function(e,t,n){return this.protocol.domain(e,this.logger.subLogger("domain="+e),t,n)},e.prototype.authToken=function(){return this.protocol.authToken()},e.prototype.reconnect=function(){return this.transport.reconnect()},e.prototype.distributeMessage=function(e,t){var n=this,o=this.messageHandlers[t.toLowerCase()];void 0!==o&&Object.keys(o).forEach((function(t){var r=o[t];if(void 0!==r)try{r(e)}catch(e){try{n.logger.error("Message handler failed with "+e.stack,e)}catch(t){console.log("Message handler failed",e)}}}))},e.prototype.handleConnectionChanged=function(e){this._connected!==e&&(this._connected=e,e?this.registry.execute("connected"):this.registry.execute("disconnected"))},e.prototype.handleTransportMessage=function(e){var t;t="string"==typeof e?this.protocol.processStringMessage(e):this.protocol.processObjectMessage(e),this.isTrace&&this.logger.trace("<< "+JSON.stringify(t)),this.distributeMessage(t.msg,t.msgType)},e}(),ie=["trace","debug","info","warn","error","off"],se=function(){function e(e,t,n){this.name=e,this.parent=t,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=e,this.path=t?t.path+"."+e:e,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}return e.prototype.subLogger=function(t){var n=this.subLoggers.filter((function(e){return e.name===t}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(e){if(e===t)throw new Error("This sub logger name is not allowed.")}));var o=new e(t,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(o),o},e.prototype.publishLevel=function(e){var t;return e&&(this._publishLevel=e),this._publishLevel||(null===(t=this.parent)||void 0===t?void 0:t.publishLevel())},e.prototype.consoleLevel=function(e){var t;return e&&(this._consoleLevel=e),this._consoleLevel||(null===(t=this.parent)||void 0===t?void 0:t.consoleLevel())},e.prototype.log=function(e,t,n){this.publishMessage(t||"info",e,n)},e.prototype.trace=function(e){this.log(e,"trace")},e.prototype.debug=function(e){this.log(e,"debug")},e.prototype.info=function(e){this.log(e,"info")},e.prototype.warn=function(e){this.log(e,"warn")},e.prototype.error=function(e,t){this.log(e,"error")},e.prototype.canPublish=function(e,t){return ie.indexOf(e)>=ie.indexOf(t||this.consoleLevel()||"trace")},e.prototype.publishMessage=function(t,n,o){var r=this.loggerFullName;if("error"===t&&!o){var i=new Error;i.stack&&(n=n+"\n"+i.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(t,this.publishLevel())){var s=e.Interop;if(s)try{s.methods({name:e.InteropMethodName}).length>0&&s.invoke(e.InteropMethodName,{msg:""+n,logger:r,level:t})}catch(e){}}if(this.canPublish(t)){var a="";if(this.includeTimeAndLevel){var c=new Date;a="["+(c.getHours()+":"+c.getMinutes()+":"+c.getSeconds()+":"+c.getMilliseconds())+"] ["+t+"] "}var u=""+a+r+": "+n;switch(t){case"trace":this.logFn.debug(u);break;case"debug":this.logFn.debug?this.logFn.debug(u):this.logFn.log(u);break;case"info":this.logFn.info(u);break;case"warn":this.logFn.warn(u);break;case"error":this.logFn.error(u,o)}}},e.InteropMethodName="T42.AppLogger.Log",e}(),ae="create-context",ce="created",ue="destroyed",de="context-created",pe="context-added",he="subscribe-context",le="subscribed-context",fe="unsubscribe-context",ge="destroy-context",ve="context-destroyed",me="update-context",ye="context-updated",be="joined",we={get name(){return"context"},get types(){return[ae,ce,ue,de,pe,he,le,fe,ge,ve,me,ye,be]}},Se="5.6.3";var _e=function(){function e(e,t,n,o){this.updateCallbacks={},this.contextId=e,this.name=t,this.isAnnounced=n,this.activityId=o,this.context={}}return e.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},e.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},e}();function Ie(e,t,o){try{if((null==o?void 0:o.canPublish("trace"))&&(null==o||o.trace("applying context delta "+JSON.stringify(t)+" on context "+JSON.stringify(e))),!t)return e;if(t.reset)return e=n({},t.reset);if(e=xe(e,void 0),t.commands){for(var r=0,i=t.commands;r<i.length;r++){var s=i[r];"remove"===s.type?Te(e,s.path):"set"===s.type&&Ce(e,s.value,s.path)}return e}var a=t.added,c=t.updated,u=t.removed;return a&&Object.keys(a).forEach((function(t){e[t]=a[t]})),c&&Object.keys(c).forEach((function(t){ke(t,e,c)})),u&&u.forEach((function(t){delete e[t]})),e}catch(n){return null==o||o.error("error applying context delta "+JSON.stringify(t)+" on context "+JSON.stringify(e),n),e}}function xe(e,t){if(t=t||new WeakMap,Object(e)!==e)return e;if(e instanceof Set)return new Set(e);if(t.has(e))return t.get(e);var n=e instanceof Date?new Date(e):e instanceof RegExp?new RegExp(e.source,e.flags):e.constructor?new e.constructor:Object.create(null);return t.set(e,n),e instanceof Map&&Array.from(e,(function(e){var o=e[0],r=e[1];return n.set(o,xe(r,t))})),Object.assign.apply(Object,i([n],Object.keys(e).map((function(n){var o;return(o={})[n]=xe(e[n],t),o}))))}var ke=function(e,t,n){var o=n[e];if(void 0===o)return t;var r=t[e];return r&&o?"string"==typeof r||"number"==typeof r||"boolean"==typeof r||"string"==typeof o||"number"==typeof o||"boolean"==typeof o||Array.isArray(r)||Array.isArray(o)?(t[e]=o,t):(t[e]=Object.assign({},r,o),t):(t[e]=o,t)};function Me(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(var n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(e[n]!==t[n]){if("object"!=typeof e[n])return!1;if(!Me(e[n],t[n]))return!1}}for(var n in t)if(t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}function Ce(e,t,n){var o,r=n.split(".");for(o=0;o<r.length-1;o++)e[r[o]]||(e[r[o]]={}),"object"!=typeof e[r[o]]&&(e[r[o]]={}),e=e[r[o]];e[r[o]]=t}function Te(e,t){var n,o=t.split(".");for(n=0;n<o.length-1;n++){if(!e[o[n]])return;e=e[o[n]]}delete e[o[n]]}var je,Pe=function(){function e(e){var t,n=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._protocolVersion=void 0,this._connection=e.connection,this._logger=e.logger,this._gw3Session=this._connection.domain("global",[de,le,ve,ye]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(t=this._connection.replayer)||void 0===t||t.drain(we.name,(function(e){var t=e.type;t&&(t===de||t===pe||t===ce?n.handleContextCreatedMessage(e):t===le||t===ye||t===be?n.handleContextUpdatedMessage(e):t!==ve&&t!==ue||n.handleContextDestroyedMessage(e))}))}return Object.defineProperty(e.prototype,"protocolVersion",{get:function(){var e;if(!this._protocolVersion){var t=this._connection.availableDomains.find((function(e){return"context"===e.uri}));this._protocolVersion=null!==(e=null==t?void 0:t.version)&&void 0!==e?e:1}return this._protocolVersion},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"setPathSupported",{get:function(){return this.protocolVersion>=2},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){for(var e=0,t=this._gw3Subscriptions;e<t.length;e++){var n=t[e];this._connection.off(n)}for(var o in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(o)&&delete this._contextNameToData[o]},e.prototype.createContext=function(e,t){var n=this;return this._gw3Session.send({type:ae,domain:"global",name:e,data:t,lifetime:"retained"}).then((function(o){n._contextNameToId[e]=o.context_id,n._contextIdToName[o.context_id]=e;var r=n._contextNameToData[e]||new _e(o.context_id,e,!0,void 0);return r.isAnnounced=!0,r.name=e,r.contextId=o.context_id,r.context=o.data||t,r.hasReceivedSnapshot=!0,n._contextNameToData[e]=r,o.context_id}))},e.prototype.all=function(){var e=this;return Object.keys(this._contextNameToData).filter((function(t){return e._contextNameToData[t].isAnnounced}))},e.prototype.update=function(e,t){var n;return o(this,void 0,void 0,(function(){var o,i,s,a=this;return r(this,(function(r){switch(r.label){case 0:return(o=this._contextNameToData[e])&&o.isAnnounced?(i=o.context,o.hasCallbacks()?[3,2]:[4,this.get(o.name)]):[2,this.createContext(e,t)];case 1:i=r.sent(),r.label=2;case 2:return s=2===this.protocolVersion?this.calculateContextDeltaV2(i,t):this.calculateContextDeltaV1(i,t),Object.keys(s.added).length||Object.keys(s.updated).length||s.removed.length||(null===(n=s.commands)||void 0===n?void 0:n.length)?[2,this._gw3Session.send({type:me,domain:"global",context_id:o.contextId,delta:s},{},{skipPeerId:!1}).then((function(e){a.handleUpdated(o,s,{updaterId:e.peer_id})}))]:[2,Promise.resolve()]}}))}))},e.prototype.set=function(e,t){var n=this,o=this._contextNameToData[e];return o&&o.isAnnounced?this._gw3Session.send({type:me,domain:"global",context_id:o.contextId,delta:{reset:t}},{},{skipPeerId:!1}).then((function(e){n.handleUpdated(o,{reset:t,added:{},removed:[],updated:{}},{updaterId:e.peer_id})})):this.createContext(e,t)},e.prototype.setPath=function(e,t,n){return this.setPathSupported?this.setPaths(e,[{path:t,value:n}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")},e.prototype.setPaths=function(e,t){var n=this;if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");var o=this._contextNameToData[e];if(!o||!o.isAnnounced){for(var r={},i=0,s=t;i<s.length;i++){Ce(r,(d=s[i]).value,d.path)}return this.createContext(e,r)}for(var a=[],c=0,u=t;c<u.length;c++){var d;null===(d=u[c]).value?a.push({type:"remove",path:d.path}):a.push({type:"set",path:d.path,value:d.value})}return this._gw3Session.send({type:me,domain:"global",context_id:o.contextId,delta:{commands:a}},{},{skipPeerId:!1}).then((function(e){n.handleUpdated(o,{added:{},removed:[],updated:{},commands:a},{updaterId:e.peer_id})}))},e.prototype.get=function(e){var t,n=this,i=this._contextNameToData[e];if(!i||!i.isAnnounced)return Promise.resolve({});if(i&&(!i.hasCallbacks()||!i.hasReceivedSnapshot))return new Promise((function(t,i){return o(n,void 0,void 0,(function(){var n=this;return r(this,(function(o){return this.subscribe(e,(function(e,o,r,i){n.unsubscribe(i),t(e)})),[2]}))}))}));var s=null!==(t=null==i?void 0:i.context)&&void 0!==t?t:{};return Promise.resolve(s)},e.prototype.subscribe=function(e,t){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var o=this._contextNameToData[e];if(!o||!o.isAnnounced)return o=o||new _e(void 0,e,!1,void 0),this._contextNameToData[e]=o,o.updateCallbacks[n]=t,Promise.resolve(n);var r=o.hasCallbacks();if(o.updateCallbacks[n]=t,r){if(o.hasReceivedSnapshot)t(i=xe(o.context),i,[],n);return Promise.resolve(n)}if(o.joinedActivity){if(o.hasReceivedSnapshot)t(i=xe(o.context),i,[],n);return Promise.resolve(n)}if(o.context&&o.sentExplicitSubscription){var i;if(o.hasReceivedSnapshot)t(i=xe(o.context),i,[],n);return Promise.resolve(n)}return this.sendSubscribe(o).then((function(){return n}))},e.prototype.unsubscribe=function(e){for(var t=0,n=Object.keys(this._contextNameToData);t<n.length;t++){var o=n[t],r=(this._contextNameToId[o],this._contextNameToData[o]);if(!r)return;var i=r.hasCallbacks();delete r.updateCallbacks[e],r.isAnnounced&&i&&!r.hasCallbacks()&&r.sentExplicitSubscription&&this.sendUnsubscribe(r),r.isAnnounced||r.hasCallbacks()||delete this._contextNameToData[o]}},e.prototype.destroy=function(e){var t=this._contextNameToData[e];return t?this._gw3Session.send({type:ge,domain:"global",context_id:t.contextId}).then((function(e){})):Promise.reject("context with "+e+" does not exist")},e.prototype.handleUpdated=function(e,t,n){var o=e.context;e.context=Ie(e.context,t,this._logger),e.hasReceivedSnapshot=!0,this._contextNameToData[e.name]!==e||Me(o,e.context)||this.invokeUpdateCallbacks(e,t,n)},e.prototype.subscribeToContextCreatedMessages=function(){for(var e=0,t=[pe,de,ce];e<t.length;e++){var n=t[e],o=this._connection.on(n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(o)}},e.prototype.handleContextCreatedMessage=function(e){var t=e.type;t===ce?(this._contextNameToId[e.activity_id]=e.context_id,this._contextIdToName[e.context_id]=e.activity_id):t===pe&&(this._contextNameToId[e.name]=e.context_id,this._contextIdToName[e.context_id]=e.name);var n=this._contextIdToName[e.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+e.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+e.context_id);var o=this._contextNameToData[n];if(o){if(o.isAnnounced)return;if(!o.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");o.isAnnounced=!0,o.contextId=e.context_id,o.activityId=e.activity_id,o.sentExplicitSubscription||this.sendSubscribe(o)}else this._contextNameToData[n]=o=new _e(e.context_id,n,!0,e.activity_id)},e.prototype.subscribeToContextUpdatedMessages=function(){for(var e=0,t=[ye,le,be];e<t.length;e++){var n=t[e],o=this._connection.on(n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(o)}},e.prototype.handleContextUpdatedMessage=function(e){var t=e.type,n=e.context_id,o=this._contextNameToData[this._contextIdToName[n]],r=!o||!o.isAnnounced;if(t===be)o?(o.contextId=n,o.isAnnounced=!0,o.activityId=e.activity_id):(o=new _e(n,e.activity_id,!0,e.activity_id),this._contextNameToData[e.activity_id]=o,this._contextIdToName[n]=e.activity_id,this._contextNameToId[e.activity_id]=n),o.joinedActivity=!0;else if(!o||!o.isAnnounced)return void(t===le?((o=o||new _e(n,e.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[e.name]=o,this._contextIdToName[n]=e.name,this._contextNameToId[e.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var i=o.context;if(o.hasReceivedSnapshot=!0,t===le)o.context=e.data||{};else if(t===be)o.context=e.context_snapshot||{};else{if(t!==ye)throw new Error("Unrecognized context update message "+t);o.context=Ie(o.context,e.delta,this._logger)}!r&&Me(o.context,i)&&t!==le||this.invokeUpdateCallbacks(o,e.delta,{updaterId:e.updater_id})},e.prototype.invokeUpdateCallbacks=function(e,t,n){if((t=t||{added:{},updated:{},reset:{},removed:[]}).commands){t.added=t.updated=t.reset={},t.removed=[];for(var o=0,r=t.commands;o<r.length;o++){var i=r[o];"remove"===i.type?(-1===i.path.indexOf(".")&&t.removed.push(i.path),Ce(t.updated,null,i.path)):"set"===i.type&&Ce(t.updated,i.value,i.path)}}for(var s in e.updateCallbacks)if(e.updateCallbacks.hasOwnProperty(s))try{(0,e.updateCallbacks[s])(xe(e.context),Object.assign({},t.added||{},t.updated||{},t.reset||{}),t.removed,parseInt(s,10),n)}catch(e){this._logger.debug("callback error: "+JSON.stringify(e))}},e.prototype.subscribeToContextDestroyedMessages=function(){for(var e=0,t=[ve,ue];e<t.length;e++){var n=t[e],o=this._connection.on(n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(o)}},e.prototype.handleContextDestroyedMessage=function(e){var t,n;if(e.type===ue){if(n=e.activity_id,!(t=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+e.activity_id)}else if(t=e.context_id,!(n=this._contextIdToName[t]))return void this._logger.error("Received 'destroyed' for unknown context: "+e.context_id);delete this._contextIdToName[t],delete this._contextNameToId[n];var o=this._contextNameToData[n];delete this._contextNameToData[n],o&&o.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+t)},e.prototype.sendSubscribe=function(e){return e.sentExplicitSubscription=!0,this._gw3Session.send({type:he,domain:"global",context_id:e.contextId}).then((function(e){}))},e.prototype.sendUnsubscribe=function(e){return e.sentExplicitSubscription=!1,this._gw3Session.send({type:fe,domain:"global",context_id:e.contextId}).then((function(e){}))},e.prototype.calculateContextDeltaV1=function(e,t){var n={added:{},updated:{},removed:[],reset:void 0};if(e)for(var o=0,r=Object.keys(e);o<r.length;o++){var i=r[o];-1===Object.keys(t).indexOf(i)||null===t[i]||Me(e[i],t[i])||(n.updated[i]=t[i])}for(var s=0,a=Object.keys(t);s<a.length;s++){i=a[s];e&&-1!==Object.keys(e).indexOf(i)?null===t[i]&&n.removed.push(i):null!==t[i]&&(n.added[i]=t[i])}return n},e.prototype.calculateContextDeltaV2=function(e,t){for(var n,o,r={added:{},updated:{},removed:[],reset:void 0,commands:[]},i=0,s=Object.keys(t);i<s.length;i++){var a=s[i];if(null!==t[a])Me(e?e[a]:null,t[a])||null===(n=r.commands)||void 0===n||n.push({type:"set",path:a,value:t[a]});else null===(o=r.commands)||void 0===o||o.push({type:"remove",path:a})}return r},e}(),Re=function(){function e(e){this._bridge=new Pe(e)}return e.prototype.all=function(){return this._bridge.all()},e.prototype.update=function(e,t){return this.checkName(e),this.checkData(t),this._bridge.update(e,t)},e.prototype.set=function(e,t){return this.checkName(e),this.checkData(t),this._bridge.set(e,t)},e.prototype.setPath=function(e,t,n){return this.checkName(e),this.checkPath(t),""===t?(this.checkData(n),this.set(e,n)):this._bridge.setPath(e,t,n)},e.prototype.setPaths=function(e,t){if(this.checkName(e),!Array.isArray(t))throw new Error("Please provide the paths as an array of PathValues!");for(var n=0,o=t;n<o.length;n++){var r=o[n],i=r.path,s=r.value;this.checkPath(i),""===i&&this.checkData(s)}return this._bridge.setPaths(e,t)},e.prototype.subscribe=function(e,t){var n=this;if(this.checkName(e),"function"!=typeof t)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(e,(function(e,o,r,i,s){return t(e,o,r,(function(){return n._bridge.unsubscribe(i)}),s)})).then((function(e){return function(){n._bridge.unsubscribe(e)}}))},e.prototype.get=function(e){return this.checkName(e),this._bridge.get(e)},e.prototype.ready=function(){return Promise.resolve(this)},e.prototype.destroy=function(e){return this.checkName(e),this._bridge.destroy(e)},Object.defineProperty(e.prototype,"setPathSupported",{get:function(){return this._bridge.setPathSupported},enumerable:!0,configurable:!0}),e.prototype.checkName=function(e){if("string"!=typeof e||""===e)throw new Error("Please provide the name as a non-empty string!")},e.prototype.checkPath=function(e){if("string"!=typeof e)throw new Error("Please provide the path as a dot delimited string!")},e.prototype.checkData=function(e){if("object"!=typeof e)throw new Error("Please provide the data as an object!")},e}();function Oe(e,t,n){return"function"!=typeof t&&"function"!=typeof n?e:("function"!=typeof t?t=function(){}:"function"!=typeof n&&(n=function(){}),e.then(t,n))}function Ae(e,t,n){var o;void 0===e&&(e=0);var r=function(){o&&clearTimeout(o)};return t.then((function(){r()})).catch((function(){r()})),new Promise((function(t,r){o=setTimeout((function(){return r(n)}),e)}))}!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(je||(je={}));var Ee=function(){function e(e,t,n,o){this.protocol=e,this.repo=t,this.instance=n,this.configuration=o}return e.prototype.subscribe=function(e,t,n,o,r){var i=this,s=function(e,n,o,s){var a;t.methodResponseTimeout=null!==(a=t.methodResponseTimeout)&&void 0!==a?a:t.waitTimeoutMs,i.protocol.client.subscribe(n,t,e,o,s,r)};return Oe(new Promise((function(n,o){var r,a=function(e){n(e)},c=function(e){o(e)};if(e)if((r="string"==typeof e?{name:e}:e).name){void 0===t&&(t={});var u=t.target;if(void 0===u&&(u="best"),"string"!=typeof u||"all"===u||"best"===u){void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=t.method_response_timeout,void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=i.configuration.methodResponseTimeout)),void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=t.wait_for_method_timeout,void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=i.configuration.waitTimeoutMs));var d=0,p=i.getServerMethodsByFilterAndTarget(r,u);if(p.length>0)s(p,p[0].methods[0],a,c);else{var h=function(){if(u&&t.waitTimeoutMs)if(d+=500,(p=i.getServerMethodsByFilterAndTarget(r,u)).length>0){var n=p[0].methods[0];s(p,n,a,c)}else if(d>=t.waitTimeoutMs){s(p,"string"==typeof e?{name:e}:e,a,c)}else setTimeout(h,500)};setTimeout(h,500)}}else o(new Error('"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else o("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");else o("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")})),n,o)},e.prototype.servers=function(e){var t=void 0===e?void 0:n({},e);return this.getServers(t).map((function(e){return e.server.instance}))},e.prototype.methods=function(e){return e="string"==typeof e?{name:e}:n({},e),this.getMethods(e)},e.prototype.methodsForInstance=function(e){return this.getMethodsForInstance(e)},e.prototype.methodAdded=function(e){return this.repo.onMethodAdded(e)},e.prototype.methodRemoved=function(e){return this.repo.onMethodRemoved(e)},e.prototype.serverAdded=function(e){return this.repo.onServerAdded(e)},e.prototype.serverRemoved=function(e){return this.repo.onServerRemoved((function(t,n){e(t,n)}))},e.prototype.serverMethodAdded=function(e){return this.repo.onServerMethodAdded((function(t,n){e({server:t,method:n})}))},e.prototype.serverMethodRemoved=function(e){return this.repo.onServerMethodRemoved((function(t,n){e({server:t,method:n})}))},e.prototype.invoke=function(e,t,i,s,a,c){return o(this,void 0,void 0,(function(){var u=this;return r(this,(function(d){return[2,Oe(function(){return o(u,void 0,void 0,(function(){var o,a,c,u,d,p,h,l,f,g,v,m,y=this;return r(this,(function(r){switch(r.label){case 0:if(!(o="string"==typeof e?{name:e}:n({},e)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")];if(t||(t={}),i||(i="best"),"string"==typeof i&&"all"!==i&&"best"!==i&&"skipMine"!==i)return[2,Promise.reject(new Error('"'+i+'" is not a valid target. Valid targets are "all" and "best".'))];if(s||(s={}),void 0===s.methodResponseTimeoutMs&&(s.methodResponseTimeoutMs=s.method_response_timeout,void 0===s.methodResponseTimeoutMs&&(s.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===s.waitTimeoutMs&&(s.waitTimeoutMs=s.wait_for_method_timeout,void 0===s.waitTimeoutMs&&(s.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==s.waitTimeoutMs&&"number"!=typeof s.waitTimeoutMs)return[2,Promise.reject(new Error('"'+s.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof t)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+o.name))];if(0!==(a=this.getServerMethodsByFilterAndTarget(o,i)).length)return[3,4];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(o,i,s)];case 2:return a=r.sent(),[3,4];case 3:return r.sent(),c=n(n({},o),{getServers:function(){return[]},supportsStreaming:!1,objectTypes:null!==(g=o.objectTypes)&&void 0!==g?g:[],flags:null!==(m=null===(v=o.flags)||void 0===v?void 0:v.metadata)&&void 0!==m?m:{}}),u={method:c,called_with:t,message:"Can not find a method matching "+JSON.stringify(e)+" with server filter "+JSON.stringify(i),executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(u)];case 4:return d=s.methodResponseTimeoutMs,p=s,h=a.map((function(e){var n=Z(),o=e.methods[0],r=e.server,i=y.protocol.client.invoke(n,o,t,r,p);return Promise.race([i,Ae(d,i,{invocationId:n,message:"Invocation timeout ("+d+" ms) reached for method name: "+(null==o?void 0:o.name)+", target instance: "+JSON.stringify(r.instance)+", options: "+JSON.stringify(p),status:je.Error})])})),[4,Promise.all(h)];case 5:return l=r.sent(),f=this.getInvocationResultObj(l,o,t),l.every((function(e){return e.status===je.Error}))?[2,Promise.reject(f)]:[2,f]}}))}))}(),a,c)]}))}))},e.prototype.getInvocationResultObj=function(e,t,n){var o=e.filter((function(e){return e.status===je.Success})).reduce((function(e,o){return e=i(e,[{executed_by:o.instance,returned:o.result,called_with:n,method:t,message:o.message,status:o.status}])}),[]),r=e.filter((function(e){return e.status===je.Error})).reduce((function(e,o){return e=i(e,[{executed_by:o.instance,called_with:n,name:t.name,message:o.message}])}),[]),s=e[0];return{method:t,called_with:n,returned:s.result,executed_by:s.instance,all_return_values:o,all_errors:r,message:s.message,status:s.status}},e.prototype.tryToAwaitForMethods=function(e,t,n){var o=this;return new Promise((function(r,i){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=o.getServerMethodsByFilterAndTarget(e,t);if(c.length>0)clearInterval(a),r(c);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(a),void i()}),500);else i()}))},e.prototype.filterByTarget=function(e,t){var n=this;if("string"!=typeof e){return(Array.isArray(e)?e:[e]).reduce((function(e,o){var r=t.filter((function(e){return n.instanceMatch(o,e.server.instance)}));return e.concat(r)}),[])}if("all"===e)return i(t);if("best"===e){var o=t.find((function(e){return e.server.instance.isLocal}));if(o)return[o];if(void 0!==t[0])return[t[0]]}else if("skipMine"===e)return t.filter((function(e){return e.server.instance.peerId!==n.instance.peerId}));return[]},e.prototype.instanceMatch=function(e,t){return this.containsProps(e,t)},e.prototype.methodMatch=function(e,t){return this.containsProps(e,t)},e.prototype.containsProps=function(e,t){return Object.keys(e).filter((function(t){return void 0!==e[t]&&"function"!=typeof e[t]&&"object_types"!==t&&"display_name"!==t&&"id"!==t&&"gatewayId"!==t&&"identifier"!==t&&"_"!==t[0]})).every((function(n){var o,r=e[n],i=t[n];switch(n){case"objectTypes":o=(r||[]).every((function(e){return(i||[]).includes(e)}));break;case"flags":o=function e(t,n){return Object.keys(n).every((function(o){return"object"==typeof n[o]?e((null==t?void 0:t[o])||{},n[o]||{}):n[o]===(null==t?void 0:t[o])}))}(i||{},r||{});break;default:o=String(r).toLowerCase()===String(i).toLowerCase()}return o}))},e.prototype.getMethods=function(e){var t=this;return void 0===e?this.repo.getMethods():this.repo.getMethods().filter((function(n){return t.methodMatch(e,n)}))},e.prototype.getMethodsForInstance=function(e){var t=this,n=this.repo.getServers().filter((function(n){return t.instanceMatch(e,n.instance)}));if(0===n.length)return[];var o={};return 1===n.length?o=n[0].methods:n.forEach((function(e){Object.keys(e.methods).forEach((function(t){var n=e.methods[t];o[n.identifier]=n}))})),Object.keys(o).map((function(e){return o[e]}))},e.prototype.getServers=function(e){var t=this,n=this.repo.getServers();return void 0===e?n.map((function(e){return{server:e,methods:[]}})):n.reduce((function(n,o){var r=Object.values(o.methods).filter((function(n){return t.methodMatch(e,n)}));return r.length>0&&n.push({server:o,methods:r}),n}),[])},e.prototype.getServerMethodsByFilterAndTarget=function(e,t){var n=this.getServers(e);return this.filterByTarget(t,n)},e}(),Ne=function(){function e(e,t,n){this.protocol=e,this.repoMethod=t,this.subscription=n}return Object.defineProperty(e.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),e.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},e.prototype.push=function(e){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,e)},e}(),Le=function(){function e(e,t,n){this.protocol=e,this.repoMethod=t,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return e.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},e.prototype.acceptOnBranch=function(e){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,e)},e.prototype.reject=function(e){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,e)},e}(),De=function(){function e(e,t){var n=this;this.protocol=e,this.server=t,e.server.onSubRequest((function(e,t){return n.handleSubRequest(e,t)})),e.server.onSubAdded((function(e,t){return n.handleSubAdded(e,t)})),e.server.onSubRemoved((function(e,t){return n.handleSubRemoved(e,t)}))}return e.prototype.handleSubRequest=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionRequestHandler){var n=new Le(this.protocol,t,e);t.streamCallbacks.subscriptionRequestHandler(n)}},e.prototype.handleSubAdded=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionAddedHandler){var n=new Ne(this.protocol,t,e);t.streamCallbacks.subscriptionAddedHandler(n)}},e.prototype.handleSubRemoved=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionRemovedHandler){var n=new Ne(this.protocol,t,e);t.streamCallbacks.subscriptionRemovedHandler(n)}},e}(),qe=function(){function e(e,t,n){this.key=e,this.protocol=t,this.repoMethod=n}return e.prototype.subscriptions=function(){var e=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(t){return new Ne(e.protocol,e.repoMethod,t)}))},e.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},e.prototype.push=function(e){this.protocol.server.pushData(this.repoMethod,e,[this.key])},e}(),Fe=function(){function e(e,t,n){this._protocol=e,this._repoMethod=t,this._server=n,this.name=this._repoMethod.definition.name}return e.prototype.branches=function(e){var t=this,n=this._protocol.server.getBranchList(this._repoMethod);return e?n.indexOf(e)>-1?new qe(e,this._protocol,this._repoMethod):void 0:n.map((function(e){return new qe(e,t._protocol,t._repoMethod)}))},e.prototype.branch=function(e){return this.branches(e)},e.prototype.subscriptions=function(){var e=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(t){return new Ne(e._protocol,e._repoMethod,t)}))},Object.defineProperty(e.prototype,"definition",{get:function(){var e,t=this._repoMethod.definition;return{accepts:t.accepts,description:t.description,displayName:t.displayName,name:t.name,objectTypes:t.objectTypes,returns:t.returns,supportsStreaming:t.supportsStreaming,flags:null===(e=t.flags)||void 0===e?void 0:e.metadata}},enumerable:!0,configurable:!0}),e.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},e.prototype.push=function(e,t){if("string"!=typeof t&&!Array.isArray(t)&&void 0!==t)throw new Error("invalid branches should be string or string array");if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,e,t)},e.prototype.updateRepoMethod=function(e){this._repoMethod=e},e}(),Ue=function(){function e(e,t){this.protocol=e,this.serverRepository=t,this.invocations=0,this.currentlyUnregistering={},this.streaming=new De(e,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return e.prototype.createStream=function(e,t,o,r,i){var s=this;return Oe(new Promise((function(o,r){if(e){var a;if(!(a="string"==typeof e?{name:""+e}:n({},e)).name)return r("The name property is required for the streamDefinition object and must be unique. Stream definition: "+JSON.stringify(a));if(s.serverRepository.getList().some((function(e){return e.definition.name===a.name})))return r('A stream with the name "'+a.name+'" already exists! Please, provide a unique name for the stream.');a.supportsStreaming=!0,t||(t={}),"function"!=typeof t.subscriptionRequestHandler&&(t.subscriptionRequestHandler=function(e){e.accept()});var c=s.serverRepository.add({definition:a,streamCallbacks:t,protocolState:{}});s.protocol.server.createStream(c).then((function(){var e;i?(e=i,i.updateRepoMethod(c)):e=new Fe(s.protocol,c,s),c.stream=e,o(e)})).catch((function(e){c.repoId&&s.serverRepository.remove(c.repoId),r(e)}))}else r("The stream name must be unique! Please, provide either a unique string for a stream name to glue.interop.createStream() or a methodDefinition object with a unique name property for the stream.")})),o,r)},e.prototype.register=function(e,t){var n=this;if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof t)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof e?e:e.name));var i=function(e,i){return o(n,void 0,void 0,(function(){var n,o,s;return r(this,(function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),(n=t(e.args,e.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return o=r.sent(),i(void 0,o),[3,3];case 2:i(void 0,n),r.label=3;case 3:return[3,5];case 4:return(s=r.sent())||(s=""),i(s,s),[3,5];case 5:return[2]}}))}))};return i.userCallback=t,this.registerCore(e,i)},e.prototype.registerAsync=function(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof t)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof e?e:e.name));var n=function(e,n){try{var o=!1,r=function(e){o||n(void 0,e),o=!0},i=function(e){o||(e||(e=""),n(e,e)),o=!0},s=t(e.args,e.instance,r,i);s&&"function"==typeof s.then&&s.then(r).catch(i)}catch(e){n(e,void 0)}};return n.userCallbackAsync=t,this.registerCore(e,n)},e.prototype.unregister=function(e,t){return void 0===t&&(t=!1),o(this,void 0,void 0,(function(){var n,o;return r(this,(function(r){switch(r.label){case 0:return void 0===e?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a name property.")]:"function"!=typeof e?[3,2]:[4,this.unregisterWithPredicate(e,t)];case 1:return r.sent(),[2];case 2:return void 0===(n="string"==typeof e?{name:e}:e).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(o=this.serverRepository.getList().find((function(e){return e.definition.name===n.name&&(e.definition.supportsStreaming||!1)===t})))?[4,this.removeMethodsOrStreams([o])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return r.sent(),[2]}}))}))},e.prototype.unregisterWithPredicate=function(e,t){return o(this,void 0,void 0,(function(){var n;return r(this,(function(o){switch(o.label){case 0:return(n=this.serverRepository.getList().filter((function(t){return e(t.definition)})).filter((function(e){return(e.definition.supportsStreaming||!1)===t})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(t?"stream":"method")+" matching the specified condition!")];case 1:return o.sent(),[2]}}))}))},e.prototype.removeMethodsOrStreams=function(e){var t=this,n=[];return e.forEach((function(e){var o=t.protocol.server.unregister(e).then((function(){e.repoId&&t.serverRepository.remove(e.repoId)}));n.push(o),t.addAsCurrentlyUnregistering(e.definition.name,o)})),Promise.all(n)},e.prototype.addAsCurrentlyUnregistering=function(e,t){return o(this,void 0,void 0,(function(){var n,o=this;return r(this,(function(r){return n=new Promise((function(e){return setTimeout(e,5e3)})),this.currentlyUnregistering[e]=Promise.race([t,n]).then((function(){delete o.currentlyUnregistering[e]})),[2]}))}))},e.prototype.registerCore=function(e,t){return o(this,void 0,void 0,(function(){var o,i,s,a=this;return r(this,(function(r){switch(r.label){case 0:return(o="string"==typeof e?{name:""+e}:n({},e)).name?(i=this.currentlyUnregistering[o.name])?[4,i]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the name property in the methodDefinition object: "+JSON.stringify(e))];case 1:r.sent(),r.label=2;case 2:return this.serverRepository.getList().some((function(e){return e.definition.name===o.name}))?[2,Promise.reject('A method with the name "'+o.name+'" already exists! Please, provide a unique name for the method.')]:o.supportsStreaming?[2,Promise.reject("When you create methods with glue.interop.register() or glue.interop.registerAsync() the property supportsStreaming cannot be true. If you want "+o.name+" to be a stream, please use the glue.interop.createStream() method.")]:(s=this.serverRepository.add({definition:o,theFunction:t,protocolState:{}}),[2,this.protocol.server.register(s).catch((function(e){throw(null==s?void 0:s.repoId)&&a.serverRepository.remove(s.repoId),e}))])}}))}))},e.prototype.onMethodInvoked=function(e,t,n){var o=this;e&&e.theFunction&&e.theFunction(n,(function(n,r){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(e){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}r?("object"!=typeof r||Array.isArray(r))&&(r={_value:r}):r={},o.protocol.server.methodInvocationResult(e,t,n,r)}))},e}(),Be=function(){function e(e,t,n){var o=this;this.wrapped={},this.wrapped.getMethods=function(){return e.methodsForInstance(this)},this.wrapped.getStreams=function(){return e.methodsForInstance(this).filter((function(e){return e.supportsStreaming}))},t&&this.refreshWrappedObject(t),n&&(n.loggedIn((function(){o.refresh(n)})),this.refresh(n))}return e.prototype.unwrap=function(){return this.wrapped},e.prototype.refresh=function(e){if(e){var t=null==e?void 0:e.resolvedIdentity,n=Object.assign({},null!=t?t:{},{peerId:null==e?void 0:e.peerId});this.refreshWrappedObject(n)}},e.prototype.refreshWrappedObject=function(e){var t,n,o,r,i=this;Object.keys(e).forEach((function(t){i.wrapped[t]=e[t]})),this.wrapped.user=e.user,this.wrapped.instance=e.instance,this.wrapped.application=null!==(t=e.application)&&void 0!==t?t:Z(),this.wrapped.applicationName=e.applicationName,this.wrapped.pid=null!==(o=null!==(n=e.pid)&&void 0!==n?n:e.process)&&void 0!==o?o:Math.floor(1e10*Math.random()),this.wrapped.machine=e.machine,this.wrapped.environment=e.environment,this.wrapped.region=e.region,this.wrapped.windowId=e.windowId,this.wrapped.isLocal=null===(r=e.isLocal)||void 0===r||r,this.wrapped.api=e.api,this.wrapped.service=e.service,this.wrapped.peerId=e.peerId},e}(),Je=function(e){return n(n({},e),{flags:e.flags.metadata||{}})},Ve=function(){function e(e,t){this.logger=e,this.API=t,this.servers={},this.methodsCount={},this.callbacks=C();var n=this.API.instance.peerId;this.myServer={id:n,methods:{},instance:this.API.instance,wrapper:this.API.unwrappedInstance},this.servers[n]=this.myServer}return e.prototype.addServer=function(e,t){this.logger.debug("adding server "+t);var n=this.servers[t];if(n)return n.id;var o=new Be(this.API,e),r={id:t,methods:{},instance:o.unwrap(),wrapper:o};return this.servers[t]=r,this.callbacks.execute("onServerAdded",r.instance),t},e.prototype.removeServerById=function(e,t){var n=this,o=this.servers[e];o?(this.logger.debug("removing server "+e),Object.keys(o.methods).forEach((function(t){n.removeServerMethod(e,t)})),delete this.servers[e],this.callbacks.execute("onServerRemoved",o.instance,t)):this.logger.warn("not aware of server "+e+", my state "+JSON.stringify(Object.keys(this.servers)))},e.prototype.addServerMethod=function(e,t){var n,o=this.servers[e];if(!o)throw new Error("server does not exists");if(!o.methods[t.id]){var r=this.createMethodIdentifier(t),i=this,s={identifier:r,gatewayId:t.id,name:t.name,displayName:t.display_name,description:t.description,version:t.version,objectTypes:t.object_types||[],accepts:t.input_signature,returns:t.result_signature,supportsStreaming:void 0!==t.flags&&t.flags.streaming,flags:null!==(n=t.flags)&&void 0!==n?n:{},getServers:function(){return i.getServersByMethod(r)}};s.object_types=s.objectTypes,s.display_name=s.displayName,s.version=s.version,o.methods[t.id]=s;var a=Je(s);return this.methodsCount[r]||(this.methodsCount[r]=0,this.callbacks.execute("onMethodAdded",a)),this.methodsCount[r]=this.methodsCount[r]+1,this.callbacks.execute("onServerMethodAdded",o.instance,a),s}},e.prototype.removeServerMethod=function(e,t){var n=this.servers[e];if(!n)throw new Error("server does not exists");var o=n.methods[t];delete n.methods[t];var r=Je(o);this.methodsCount[o.identifier]=this.methodsCount[o.identifier]-1,0===this.methodsCount[o.identifier]&&this.callbacks.execute("onMethodRemoved",r),this.callbacks.execute("onServerMethodRemoved",n.instance,r)},e.prototype.getMethods=function(){return this.extractMethodsFromServers(Object.values(this.servers)).map(Je)},e.prototype.getServers=function(){return Object.values(this.servers).map(this.hideServerMethodSystemFlags)},e.prototype.onServerAdded=function(e){var t=this.callbacks.add("onServerAdded",e),n=this.getServers().map((function(e){return e.instance}));return this.returnUnsubWithDelayedReplay(t,n,e)},e.prototype.onMethodAdded=function(e){var t=this.callbacks.add("onMethodAdded",e),n=this.getMethods();return this.returnUnsubWithDelayedReplay(t,n,e)},e.prototype.onServerMethodAdded=function(e){var t=this.callbacks.add("onServerMethodAdded",e),n=!1,o=this.getServers();return setTimeout((function(){o.forEach((function(t){var o=t.methods;Object.keys(o).forEach((function(r){n||e(t.instance,o[r])}))}))}),0),function(){n=!0,t()}},e.prototype.onMethodRemoved=function(e){return this.callbacks.add("onMethodRemoved",e)},e.prototype.onServerRemoved=function(e){return this.callbacks.add("onServerRemoved",e)},e.prototype.onServerMethodRemoved=function(e){return this.callbacks.add("onServerMethodRemoved",e)},e.prototype.getServerById=function(e){return this.hideServerMethodSystemFlags(this.servers[e])},e.prototype.reset=function(){var e,t=this;Object.keys(this.servers).forEach((function(e){t.removeServerById(e,"reset")})),this.servers=((e={})[this.myServer.id]=this.myServer,e),this.methodsCount={}},e.prototype.createMethodIdentifier=function(e){var t=void 0!==e.input_signature?e.input_signature:"",n=void 0!==e.result_signature?e.result_signature:"";return(e.name+t+n).toLowerCase()},e.prototype.getServersByMethod=function(e){var t=[];return Object.values(this.servers).forEach((function(n){Object.values(n.methods).forEach((function(o){o.identifier===e&&t.push(n.instance)}))})),t},e.prototype.returnUnsubWithDelayedReplay=function(e,t,n){var o=!1;return setTimeout((function(){t.forEach((function(e){o||n(e)}))}),0),function(){o=!0,e()}},e.prototype.hideServerMethodSystemFlags=function(e){var t={};return Object.entries(e.methods).forEach((function(e){var n=e[0],o=e[1];t[n]=Je(o)})),n(n({},e),{methods:t})},e.prototype.extractMethodsFromServers=function(e){return Object.values(e).reduce((function(e,t){return i(e,Object.values(t.methods))}),[])},e}(),We=function(){function e(){this.nextId=0,this.methods=[]}return e.prototype.add=function(e){return e.repoId=String(this.nextId),this.nextId+=1,this.methods.push(e),e},e.prototype.remove=function(e){if("string"!=typeof e)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(t){return t.repoId!==e}))},e.prototype.getById=function(e){if("string"==typeof e)return this.methods.find((function(t){return t.repoId===e}))},e.prototype.getList=function(){return this.methods.map((function(e){return e}))},e.prototype.length=function(){return this.methods.length},e.prototype.reset=function(){this.methods=[]},e}(),He="onSubscriptionRequest",Ke="onSubscriptionAdded",Ge="onSubscriptionRemoved",ze=function(){function e(e,t,n){var o=this;this.session=e,this.repository=t,this.serverRepository=n,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=C(),this.nextStreamId=0,e.on("add-interest",(function(e){o.handleAddInterest(e)})),e.on("remove-interest",(function(e){o.handleRemoveInterest(e)}))}return e.prototype.acceptRequestOnBranch=function(e,t,n){if("string"!=typeof n&&(n=""),"object"!=typeof t.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(t.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var o=this.getStreamId(t,n),r=e.msg.subscription_id,i={id:r,arguments:e.arguments,instance:e.instance,branchKey:n,streamId:o,subscribeMsg:e.msg};t.protocolState.subscriptionsMap[r]=i,this.session.sendFireAndForget({type:"accepted",subscription_id:r,stream_id:o}),this.callbacks.execute(Ke,i,t)},e.prototype.rejectRequest=function(e,t,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,e.msg.subscription_id)},e.prototype.pushData=function(e,t,n){var o=this;if("object"==typeof e&&Array.isArray(e.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]),e.protocolState.branchKeyToStreamIdMap.filter((function(e){return!n||0===n.length||n.indexOf(e.key)>=0})).map((function(e){return e.streamId})).forEach((function(e){var n={type:"publish",stream_id:e,data:t};o.session.sendFireAndForget(n)}))}},e.prototype.pushDataToSingle=function(e,t,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var o={type:"post",subscription_id:t.id,data:n};this.session.sendFireAndForget(o)},e.prototype.closeSingleSubscription=function(e,t){e.protocolState.subscriptionsMap&&delete e.protocolState.subscriptionsMap[t.id];var n={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);t.instance;this.callbacks.execute(Ge,t,e)},e.prototype.closeMultipleSubscriptions=function(e,t){var n=this;if("object"==typeof e&&"object"==typeof e.protocolState.subscriptionsMap&&e.protocolState.subscriptionsMap){var o=e.protocolState.subscriptionsMap,r=Object.keys(o).map((function(e){return o[e]}));"string"==typeof t&&(r=r.filter((function(e){return e.branchKey===t}))),r.forEach((function(e){delete o[e.id];var t={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping all subscriptions on stream_id: "+e.streamId};n.session.sendFireAndForget(t)}))}},e.prototype.getSubscriptionList=function(e,t){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];var n=e.protocolState.subscriptionsMap,o=Object.keys(n).map((function(e){return n[e]}));return"string"!=typeof t?o:o.filter((function(e){return e.branchKey===t}))},e.prototype.getBranchList=function(e){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];var t=e.protocolState.subscriptionsMap,n=Object.keys(t).map((function(e){return t[e]})),o=[];return n.forEach((function(e){var t="";"object"==typeof e&&"string"==typeof e.branchKey&&(t=e.branchKey),-1===o.indexOf(t)&&o.push(t)})),o},e.prototype.onSubAdded=function(e){this.onSubscriptionLifetimeEvent(Ke,e)},e.prototype.onSubRequest=function(e){this.onSubscriptionLifetimeEvent(He,e)},e.prototype.onSubRemoved=function(e){this.onSubscriptionLifetimeEvent(Ge,e)},e.prototype.handleRemoveInterest=function(e){var t=this.serverRepository.getById(e.method_id);if("string"==typeof e.subscription_id&&"object"==typeof t&&t.protocolState.subscriptionsMap&&"object"==typeof t.protocolState.subscriptionsMap[e.subscription_id]){var n=t.protocolState.subscriptionsMap[e.subscription_id];delete t.protocolState.subscriptionsMap[e.subscription_id],this.callbacks.execute(Ge,n,t)}},e.prototype.onSubscriptionLifetimeEvent=function(e,t){this.callbacks.add(e,t)},e.prototype.getNextStreamId=function(){return this.nextStreamId+++""},e.prototype.handleAddInterest=function(e){var t=this.repository.getServerById(e.caller_id).instance,n={msg:e,arguments:e.arguments_kv||{},instance:t},o=this.serverRepository.getById(e.method_id);if(void 0!==o)o.protocolState.subscriptionsMap&&o.protocolState.subscriptionsMap[e.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+e.subscription_id+" already exists.",e.subscription_id):this.callbacks.execute(He,n,o);else{var r="No method with id "+e.method_id+" on this server.";this.sendSubscriptionFailed(r,e.subscription_id)}},e.prototype.sendSubscriptionFailed=function(e,t){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:e,request_id:t};this.session.sendFireAndForget(n)},e.prototype.getStreamId=function(e,t){if("string"!=typeof t&&(t=""),!e.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+e.definition.name+" method without protocol state");var n=e.protocolState.branchKeyToStreamIdMap.filter((function(e){return e.key===t}))[0],o=n?n.streamId:void 0;return"string"==typeof o&&""!==o||(o=this.getNextStreamId(),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:o})),o},e}(),Xe=function(){function e(e,t,n,o){var r=this;this.session=e,this.clientRepository=t,this.serverRepository=n,this.logger=o,this.callbacks=C(),this.streaming=new ze(e,t,n),this.session.on("invoke",(function(e){return r.handleInvokeMessage(e)}))}return e.prototype.createStream=function(e){return e.protocolState.subscriptionsMap={},e.protocolState.branchKeyToStreamIdMap=[],this.register(e,!0)},e.prototype.register=function(e,t){var n,o=this,r=e.definition,i=Object.assign({},{metadata:null!==(n=r.flags)&&void 0!==n?n:{}},{streaming:t||!1}),s={type:"register",methods:[{id:e.repoId,name:r.name,display_name:r.displayName,description:r.description,version:r.version,flags:i,object_types:r.objectTypes||r.object_types,input_signature:r.accepts,result_signature:r.returns,restrictions:void 0}]};return this.session.send(s,{methodId:e.repoId}).then((function(){o.logger.debug("registered method "+e.definition.name+" with id "+e.repoId)})).catch((function(t){throw o.logger.warn("failed to register method "+e.definition.name+" with id "+e.repoId+" - "+JSON.stringify(t)),t}))},e.prototype.onInvoked=function(e){this.callbacks.add("onInvoked",e)},e.prototype.methodInvocationResult=function(e,t,n,o){var r;r=n||""===n?{type:"error",request_id:t,reason_uri:"agm.errors.client_error",reason:n,context:o,peer_id:void 0}:{type:"yield",invocation_id:t,peer_id:this.session.peerId,result:o,request_id:void 0},this.session.sendFireAndForget(r)},e.prototype.unregister=function(e){return o(this,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:return t={type:"unregister",methods:[e.repoId]},[4,this.session.send(t)];case 1:return n.sent(),[2]}}))}))},e.prototype.getBranchList=function(e){return this.streaming.getBranchList(e)},e.prototype.getSubscriptionList=function(e,t){return this.streaming.getSubscriptionList(e,t)},e.prototype.closeAllSubscriptions=function(e,t){this.streaming.closeMultipleSubscriptions(e,t)},e.prototype.pushData=function(e,t,n){this.streaming.pushData(e,t,n)},e.prototype.pushDataToSingle=function(e,t,n){this.streaming.pushDataToSingle(e,t,n)},e.prototype.closeSingleSubscription=function(e,t){this.streaming.closeSingleSubscription(e,t)},e.prototype.acceptRequestOnBranch=function(e,t,n){this.streaming.acceptRequestOnBranch(e,t,n)},e.prototype.rejectRequest=function(e,t,n){this.streaming.rejectRequest(e,t,n)},e.prototype.onSubRequest=function(e){this.streaming.onSubRequest(e)},e.prototype.onSubAdded=function(e){this.streaming.onSubAdded(e)},e.prototype.onSubRemoved=function(e){this.streaming.onSubRemoved(e)},e.prototype.handleInvokeMessage=function(e){var t=e.invocation_id,n=e.caller_id,o=e.method_id,r=e.arguments_kv,i=this.serverRepository.getList().filter((function(e){return e.repoId===o}))[0];if(void 0!==i){var s={args:r,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",i,t,s)}},e}(),Ye=function(){function e(e,t){this.repository=e,this.subscriptionData=t}return Object.defineProperty(e.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"servers",{get:function(){var e=this;return this.subscriptionData.trackedServers.filter((function(e){return e.subscriptionId})).map((function(t){return e.repository.getServerById(t.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),e.prototype.onData=function(e){if("function"!=typeof e)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(e),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(t){e(t)}))},e.prototype.onClosed=function(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(e)},e.prototype.onFailed=function(e){},e.prototype.onConnected=function(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(e)},e.prototype.close=function(){this.subscriptionData.close()},e.prototype.setNewSubscription=function(e){this.subscriptionData=e},e}(),Qe="awaitingAccept",Ze="subscribed",$e="Subscription failed.",et="ClientInitiated",tt=function(){function e(e,t,n){var o=this;this.session=e,this.repository=t,this.logger=n,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(e){var t=e._tag,n=t.subLocalKey,r=o.subscriptionsList[n];if("object"==typeof r&&(r.trackedServers=r.trackedServers.filter((function(e){return e.serverId!==t.serverId})),r.trackedServers.length<=0)){if(clearTimeout(r.timeoutId),r.status===Qe){var i="string"==typeof e.reason&&""!==e.reason?' Publisher said "'+e.reason+'".':" No reason given.",s="object"==typeof r.params.arguments?JSON.stringify(r.params.arguments):"{}";r.error({message:"Subscription rejected."+i+" Called with:"+s,called_with:r.params.arguments,method:r.method})}else r.status===Ze&&o.callOnClosedHandlers(r);delete o.subscriptionsList[n]}},this.handleSubscribed=function(e){var t=e._tag.subLocalKey,n=o.subscriptionsList[t];if("object"==typeof n){var r=e._tag.serverId,i=n.trackedServers.filter((function(e){return e.serverId===r}))[0];if("object"==typeof i){i.subscriptionId=e.subscription_id,o.subscriptionIdToLocalKeyMap[e.subscription_id]=t;var s=n.status===Qe;if(n.status=Ze,s){var a=!1,c=n.subscription;c?(c.setNewSubscription(n),n.success(c),a=!0):(c=new Ye(o.repository,n),n.subscription=c,n.success(c));for(var u=0,d=n.handlers.onConnected;u<d.length;u++){var p=d[u];try{p(c.serverInstance,a)}catch(e){}}}}}},this.handleEventData=function(e){var t=o.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0!==t){var n=o.subscriptionsList[t];if("object"==typeof n){var r=n.trackedServers.filter((function(t){return t.subscriptionId===e.subscription_id}));if(1===r.length){var i=e.oob,s=r[0].serverId,a=function(){return{data:e.data,server:o.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:i}},c=n.handlers.onData,u=n.queued.data;c.length>0?c.forEach((function(e){"function"==typeof e&&e(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(e){var t=o.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0!==t){var n=o.subscriptionsList[t];if("object"==typeof n){var r=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(t){return t.subscriptionId!==e.subscription_id||(n.queued.closers.push(t.serverId),!1)})),n.trackedServers.length===r&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),o.callOnClosedHandlers(n),delete o.subscriptionsList[t]),delete o.subscriptionIdToLocalKeyMap[e.subscription_id])}}},e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}return e.prototype.subscribe=function(e,t,n,o,r,i){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,e,t,o,r,t.methodResponseTimeout||1e4,i);"object"==typeof c?n.forEach((function(n){var o=n.server.id,r=n.methods.find((function(t){return t.name===e.name}));if(r){c.trackedServers.push({serverId:o,subscriptionId:void 0});var i={type:"subscribe",server_id:o,method_id:r.gatewayId,arguments_kv:t.arguments};s.session.send(i,{serverId:o,subLocalKey:a}).then((function(e){return s.handleSubscribed(e)})).catch((function(e){return s.handleErrorSubscribing(e)}))}else s.logger.error("can not find method "+e.name+" for target "+n.server.id)})):r({method:e,called_with:t.arguments,message:$e+" Unable to register the user callbacks."})}else r({method:e,called_with:t.arguments,message:$e+" No available servers matched the target params."})},e.prototype.drainSubscriptions=function(){var e=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},e},e.prototype.getNextSubscriptionLocalKey=function(){var e=this.nextSubLocalKey;return this.nextSubLocalKey+=1,e},e.prototype.registerSubscription=function(e,t,n,o,r,i,s){var a=this,c={localKey:e,status:Qe,method:t,params:n,success:o,error:r,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(e)},subscription:null==s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[e]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[e]){var o=a.subscriptionsList[e];o.status===Qe?(r({method:t,called_with:n.arguments,message:$e+" Subscription attempt timed out after "+i+" ms."}),delete a.subscriptionsList[e]):o.status===Ze&&o.trackedServers.length>0&&(o.trackedServers=o.trackedServers.filter((function(e){return void 0!==e.subscriptionId})),delete o.timeoutId,o.trackedServers.length<=0&&(a.callOnClosedHandlers(o),delete a.subscriptionsList[e]))}}),i),c},e.prototype.callOnClosedHandlers=function(e,t){var n,o=e.queued.closers.length,r=o>0?e.queued.closers[o-1]:null;void 0!==r&&"string"==typeof r&&(n=this.repository.getServerById(r).instance),e.handlers.onClosed.forEach((function(o){"function"==typeof o&&o({message:t||"ServerInitiated",requestArguments:e.params.arguments||{},server:n,stream:e.method})}))},e.prototype.closeSubscription=function(e){var t=this,n=this.subscriptionsList[e];"object"==typeof n&&(n.trackedServers.forEach((function(e){void 0!==e.subscriptionId&&(n.queued.closers.push(e.serverId),t.session.sendFireAndForget({type:"unsubscribe",subscription_id:e.subscriptionId,reason_uri:"",reason:et}),delete t.subscriptionIdToLocalKeyMap[e.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,et),delete this.subscriptionsList[e])},e}(),nt=function(){function e(e,t,n){var o=this;this.session=e,this.repository=t,this.logger=n,e.on("peer-added",(function(e){return o.handlePeerAdded(e)})),e.on("peer-removed",(function(e){return o.handlePeerRemoved(e)})),e.on("methods-added",(function(e){return o.handleMethodsAddedMessage(e)})),e.on("methods-removed",(function(e){return o.handleMethodsRemovedMessage(e)})),this.streaming=new tt(e,t,n)}return e.prototype.subscribe=function(e,t,n,o,r,i){this.streaming.subscribe(e,t,n,o,r,i)},e.prototype.invoke=function(e,t,n,o){var r=this,i=o.id,s={type:"call",server_id:i,method_id:t.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:e,serverId:i}).then((function(e){return r.handleResultMessage(e)})).catch((function(e){return r.handleInvocationError(e)}))},e.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},e.prototype.handlePeerAdded=function(e){var t=e.new_peer_id,n=e.identity,o=!e.meta||e.meta.local,r=Number(n.process),i={machine:n.machine,pid:isNaN(r)?n.process:r,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:t,api:n.api,isLocal:o};this.repository.addServer(i,t)},e.prototype.handlePeerRemoved=function(e){var t=e.removed_id,n=e.reason;this.repository.removeServerById(t,n)},e.prototype.handleMethodsAddedMessage=function(e){var t=this,n=e.server_id;e.methods.forEach((function(e){t.repository.addServerMethod(n,e)}))},e.prototype.handleMethodsRemovedMessage=function(e){var t=this,n=e.server_id,o=e.methods,r=this.repository.getServerById(n);Object.keys(r.methods).forEach((function(e){var i=r.methods[e];o.indexOf(i.gatewayId)>-1&&t.repository.removeServerMethod(n,e)}))},e.prototype.handleResultMessage=function(e){var t=e._tag.invocationId,n=e.result,o=e._tag.serverId;return{invocationId:t,result:n,instance:this.repository.getServerById(o).instance,status:je.Success,message:""}},e.prototype.handleInvocationError=function(e){if(this.logger.debug("handle invocation error "+JSON.stringify(e)),"_tag"in e){var t=e._tag.invocationId,n=e._tag.serverId,o=this.repository.getServerById(n),r=e.reason;return{invocationId:t,result:e.context,instance:o.instance,status:je.Error,message:r}}return{invocationId:"",message:e.message,status:je.Error,error:e}},e}();function ot(e,t,n,o,r,i){var s,a=r.logger.subLogger("gw3-protocol"),c=new Promise((function(e){s=e})),u=t.domain("agm",["subscribed"]),d=new Xe(u,n,o,a.subLogger("server")),p=new nt(u,n,a.subLogger("client"));return u.onJoined((function(r){n.addServer(e,t.peerId),r?function(){a.info("reconnected - will replay registered methods and subscriptions");for(var e=0,t=p.drainSubscriptions();e<t.length;e++){var n=t[e],r=n.method,s=Object.assign({},n.params);a.info("trying to re-subscribe to method "+r.name),i.client.subscribe(r,s,void 0,void 0,n)}var c=o.getList();o.reset();for(var u=0,d=c;u<d.length;u++){var h=d[u],l=h.definition;a.info("re-publishing method "+l.name),h.stream?i.server.createStream(l,h.streamCallbacks,void 0,void 0,h.stream):h.theFunction&&h.theFunction.userCallback?i.register(l,h.theFunction.userCallback):h.theFunction&&h.theFunction.userCallbackAsync&&i.registerAsync(l,h.theFunction.userCallbackAsync)}}():s&&(s({client:p,server:d}),s=void 0)})),u.onLeft((function(){n.reset()})),u.join(),c}var rt=function(){function e(e){var t=this;if(void 0===e)throw new Error("configuration is required");if(void 0===e.connection)throw new Error("configuration.connections is required");var n,o=e.connection;if("number"!=typeof e.methodResponseTimeout&&(e.methodResponseTimeout=3e4),"number"!=typeof e.waitTimeoutMs&&(e.waitTimeoutMs=3e4),this.unwrappedInstance=new Be(this,void 0,o),this.instance=this.unwrappedInstance.unwrap(),this.clientRepository=new Ve(e.logger.subLogger("cRep"),this),this.serverRepository=new We,3!==o.protocolVersion)throw new Error("protocol "+o.protocolVersion+" not supported");n=ot(this.instance,o,this.clientRepository,this.serverRepository,e,this),this.readyPromise=n.then((function(n){return t.protocol=n,t.client=new Ee(t.protocol,t.clientRepository,t.instance,e),t.server=new Ue(t.protocol,t.serverRepository),t}))}return e.prototype.ready=function(){return this.readyPromise},e.prototype.serverRemoved=function(e){return this.client.serverRemoved(e)},e.prototype.serverAdded=function(e){return this.client.serverAdded(e)},e.prototype.serverMethodRemoved=function(e){return this.client.serverMethodRemoved(e)},e.prototype.serverMethodAdded=function(e){return this.client.serverMethodAdded(e)},e.prototype.methodRemoved=function(e){return this.client.methodRemoved(e)},e.prototype.methodAdded=function(e){return this.client.methodAdded(e)},e.prototype.methodsForInstance=function(e){return this.client.methodsForInstance(e)},e.prototype.methods=function(e){return this.client.methods(e)},e.prototype.servers=function(e){return this.client.servers(e)},e.prototype.subscribe=function(e,t,n,o){return this.client.subscribe(e,t,n,o)},e.prototype.createStream=function(e,t,n,o){return this.server.createStream(e,t,n,o)},e.prototype.unregister=function(e){return this.server.unregister(e)},e.prototype.registerAsync=function(e,t){return this.server.registerAsync(e,t)},e.prototype.register=function(e,t){return this.server.register(e,t)},e.prototype.invoke=function(e,t,n,o,r,i){return this.client.invoke(e,t,n,o,r,i)},e.prototype.waitForMethod=function(e){var t=new R,n=this.client.methodAdded((function(o){o.name===e&&(n(),t.resolve(o))}));return t.promise},e}(),it=["subscribed","success"],st=function(){function e(e,t){var n=this;this.publish=function(e,t,o){var r=o||{},i=r.routingKey,s=r.target,a=n.removeEmptyValues({type:"publish",topic:e,data:t,peer_id:n.peerId,routing_key:i,target_identity:s});n.session.send(a)},this.subscribe=function(e,t,o){return new Promise((function(r,i){var s=o||{},a=s.routingKey,c=s.target,u=n.removeEmptyValues({type:"subscribe",topic:e,peer_id:n.peerId,routing_key:a,source:c});n.session.send(u).then((function(o){var i=o.subscription_id;n.subscriptions.push({subscription_id:i,topic:e,callback:t,source:c}),r({unsubscribe:function(){return n.session.send({type:"unsubscribe",subscription_id:i,peer_id:n.peerId}),n.subscriptions=n.subscriptions.filter((function(e){return e.subscription_id!==i})),Promise.resolve()}})})).catch((function(e){return i(e)}))}))},this.watchOnEvent=function(){n.session.on("event",(function(e){var t=e.data,o=e.subscription_id,r=e["publisher-identity"],i=n.subscriptions.find((function(e){return e.subscription_id===o}));i&&(i.source?n.keysMatch(i.source,r)&&i.callback(t,i.topic,r):i.callback(t,i.topic,r))}))},this.connection=e,this.logger=t,this.peerId=e.peerId,this.subscriptions=[],this.session=e.domain("bus",it),this.readyPromise=this.session.join(),this.readyPromise.then((function(){n.watchOnEvent()}))}return e.prototype.ready=function(){return this.readyPromise},e.prototype.removeEmptyValues=function(e){var t={};return Object.keys(e).forEach((function(n){void 0!==e[n]&&null!==e[n]&&(t[n]=e[n])})),t},e.prototype.keysMatch=function(e,t){var n=Object.keys(e),o=!0;return n.forEach((function(n){e[n]!==t[n]&&(o=!1)})),o},e}(),at=function(e,t){var n,i=P.getGDMajorVersion(),s=Promise.resolve();if(i){if(i<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");i>=3&&(n=window.glue42gd,s=window.gdPreloadPromise||s)}var a,c,u,d,p,h,l,f=A("glue"),g=function(e,t,n){var o,r,i,s,a,c;if(P.isNode()){var u=process.env._GD_STARTING_CONTEXT_;if(u)try{c=JSON.parse(u)}catch(e){}}function d(){if(e.application)return e.application;if(n)return n.applicationName;if("undefined"!=typeof window&&void 0!==window.glue42electron)return window.glue42electron.application;var t=Z();return P.isNode()?c?c.applicationConfig.name:"NodeJS"+t:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+" ("+t+")":t}var p=function(){var o,r,i,s,a,u,p,h,l,f,g,v=e.gateway,m=null!==(o=null==v?void 0:v.protocolVersion)&&void 0!==o?o:3,y=null==v?void 0:v.reconnectInterval,b=null==v?void 0:v.reconnectAttempts,w=null==v?void 0:v.ws,S=null==v?void 0:v.sharedWorker,_=null==v?void 0:v.inproc,I=null!==(r=null==v?void 0:v.webPlatform)&&void 0!==r?r:void 0;n&&(w=n.gwURL),P.isNode()&&c&&c.gwURL&&(w=c.gwURL),w||S||_||(w="ws://localhost:8385");var x=d(),k=x;void 0!==n?(h=n.windowId,l=n.pid,n.env&&(f=n.env.env,g=n.env.region),k=null!==(i=n.application)&&void 0!==i?i:"glue-app",p=n.appInstanceId):P.isNode()?(l=process.pid,c&&(f=c.env,g=c.region,p=c.instanceId)):void 0!==(null===window||void 0===window?void 0:window.glue42electron)&&(h=null===window||void 0===window?void 0:window.glue42electron.instanceId,l=null===window||void 0===window?void 0:window.glue42electron.pid,f=null===window||void 0===window?void 0:window.glue42electron.env,g=null===window||void 0===window?void 0:window.glue42electron.region,k=null!==(s=null===window||void 0===window?void 0:window.glue42electron.application)&&void 0!==s?s:"glue-app",p=null===window||void 0===window?void 0:window.glue42electron.instanceId);var M=null!==(u=null===(a=e.gateway)||void 0===a?void 0:a.replaySpecs)&&void 0!==u?u:[];M.push(we);var C={application:k,applicationName:x,windowId:h,instance:p,process:l,region:g,environment:f,api:t.version||Se};return e.identity&&(C=Object.assign(C,e.identity)),{identity:C,reconnectInterval:y,ws:w,sharedWorker:S,webPlatform:I,inproc:_,protocolVersion:m,reconnectAttempts:b,replaySpecs:M}}(),h=d();if("undefined"!=typeof window){var l=window,f=l.htmlContainer?l.htmlContainer.containerName+"."+l.htmlContainer.application:null===(o=null==l?void 0:l.glue42gd)||void 0===o?void 0:o.application;f&&(h=f)}return{bus:null!==(r=e.bus)&&void 0!==r&&r,application:h,auth:function(){var t,n,o;return"string"==typeof e.auth?{token:e.auth}:e.auth?e.auth:P.isNode()&&c&&c.gwToken?{gatewayToken:c.gwToken}:(null===(t=e.gateway)||void 0===t?void 0:t.webPlatform)||(null===(n=e.gateway)||void 0===n?void 0:n.inproc)||(null===(o=e.gateway)||void 0===o?void 0:o.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var t,o,r,i=e.logger,s="warn";return i||(i=s),n&&(r=n.consoleLogLevel),"string"==typeof i?{console:null!=r?r:i,publish:s}:{console:null!==(t=null!=r?r:i.console)&&void 0!==t?t:s,publish:null!==(o=i.publish)&&void 0!==o?o:s}}(),connection:p,metrics:null===(i=e.metrics)||void 0===i||i,contexts:null===(s=e.contexts)||void 0===s||s,version:t.version||Se,libs:null!==(a=t.libs)&&void 0!==a?a:[],customLogger:e.customLogger}}(e=e||{},t=t||{},n),v={};function m(e,t,n){(l=u.canPublish("trace"))&&u.trace("registering "+e+" module");var o=function(){t.initTime=n.stop(),t.initEndTime=n.endTime,t.marks=n.marks,l&&u.trace(e+" is ready - "+(n.endTime-n.startTime))};t.initStartTime=n.startTime,t.ready?t.ready().then((function(){o()})):o(),Array.isArray(e)||(e=[e]),e.forEach((function(e){v[e]=t,at[e]=t}))}function y(){var e=A("interop"),t={connection:a,logger:u.subLogger("interop")};return c=new rt(t),se.Interop=c,m(["interop","agm"],c,e),Promise.resolve()}function b(){var e=g.activities&&3===a.protocolVersion;if(g.contexts||e){var t=A("contexts");return m("contexts",p=new Re({connection:a,logger:u.subLogger("contexts")}),t),p}var n=a.replayer;n&&n.drain(we.name)}function w(){return o(this,void 0,void 0,(function(){var e;return r(this,(function(t){return g.bus?(e=A("bus"),m("bus",h=new st(a,u.subLogger("bus")),e),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function S(e){try{return e.forEach((function(e){!function(e,t){var n=A(e),o=t(v);o&&m(e,o,n)}(e.name,e.create)})),Promise.resolve()}catch(e){return Promise.reject(e)}}return s.then((function(){var e,t=A("logger");return(u=new se(""+(null===(e=g.connection.identity)||void 0===e?void 0:e.application),void 0,g.customLogger)).consoleLevel(g.logger.console),u.publishLevel(g.logger.publish),u.canPublish("debug")&&u.debug("initializing glue..."),m("logger",u,t),Promise.resolve(void 0)})).then((function(){var e=A("connection");a=new re(g.connection,u.subLogger("connection"));var t=Promise.resolve(g.auth);return g.connection&&!g.auth&&(n?t=n.getGWToken().then((function(e){return{gatewayToken:e}})):"undefined"!=typeof window&&(null===window||void 0===window?void 0:window.glue42electron)?"string"==typeof window.glue42electron.gwToken&&(t=Promise.resolve({gatewayToken:window.glue42electron.gwToken})):t=Promise.reject("You need to provide auth information")),t.then((function(t){var n;if(e.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));return n=t,a.login(n)})).then((function(){return m("connection",a,e),g})).catch((function(e){throw a&&a.logout(),e}))})).then((function(){return Promise.all([(s=A("metrics"),c=g.metrics,p=null==n?void 0:n.getMetricsPublishingEnabled,h=g.connection.identity,l=p||function(){return!0},f=null!==(e="boolean"!=typeof c&&c.disableAutoAppSystem)&&void 0!==e&&e,m("metrics",d=k({connection:c?a:void 0,logger:u.subLogger("metrics"),canUpdateMetric:l,system:"Glue42",service:null!==(o=null!==(t=null==h?void 0:h.service)&&void 0!==t?t:null==n?void 0:n.applicationName)&&void 0!==o?o:g.application,instance:null!==(i=null!==(r=null==h?void 0:h.instance)&&void 0!==r?r:null==h?void 0:h.windowId)&&void 0!==i?i:Z(),disableAutoAppSystem:f,pagePerformanceMetrics:"boolean"!=typeof c?null==c?void 0:c.pagePerformanceMetrics:void 0}),s),Promise.resolve()),y(),b(),w()]);var e,t,o,r,i,s,c,p,h,l,f})).then((function(){return c.readyPromise})).then((function(){return S(g.libs||[])})).then((function(){var e=Object.keys(v).map((function(e){var t=v[e];return t.ready?t.ready():Promise.resolve()}));return Promise.all(e)})).then((function(){var o={coreVersion:Se,version:g.version};f.stop();var r={feedback:function(e){c&&c.invoke("T42.ACS.Feedback",e,"best")},info:o,logger:u,interop:c,agm:c,connection:a,metrics:d,contexts:p,bus:h,version:g.version,userConfig:e,done:function(){return null==u||u.info("done called by user..."),a.logout()}};if(r.performance={get glueVer(){return g.version},get glueConfig(){return JSON.stringify(e)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var e=O;return Object.keys(e).map((function(t){var n=e[t];return{name:t,duration:n.endTime-n.startTime,marks:n.marks,startTime:n.startTime,endTime:n.endTime}}))}},Object.keys(v).forEach((function(e){var t=v[e];r[e]=t})),r.config={},Object.keys(g).forEach((function(e){r.config[e]=g[e]})),t&&t.extOptions&&Object.keys(t.extOptions).forEach((function(e){r.config[e]=null==t?void 0:t.extOptions[e]})),(null==t?void 0:t.enrichGlue)&&t.enrichGlue(r),n&&n.updatePerfData&&n.updatePerfData(r.performance),r.agm){var i=function(e,t,n){return function(){return r.logger.warn("glue.js - 'glue.agm."+t+"' method is deprecated, use 'glue.interop."+n+"' instead."),e.apply(r.agm,arguments)}},s=r.agm;s.method_added=i(r.agm.methodAdded,"method_added","methodAdded"),s.method_removed=i(r.agm.methodRemoved,"method_removed","methodRemoved"),s.server_added=i(r.agm.serverAdded,"server_added","serverAdded"),s.server_method_aded=i(r.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),s.server_method_removed=i(r.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return r})).catch((function(e){return Promise.reject({err:e,libs:v})}))};return"undefined"!=typeof window&&(window.GlueCore=at),at.version=Se,at.default=at,at}));
//# sourceMappingURL=core.umd.min.js.map
